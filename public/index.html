<!DOCTYPE html>
<html lang="en-US">
  <head>
    <title>pg-difficult</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <link rel="shortcut icon" href="./icon.png" />
    <script src="./ractive@1.4.2.js"></script>
    <script src="./raport@0.24.8.js"></script>
    <script src="./raport.design@0.24.8.js"></script>
    <script src="./raui@0.15.6/ace-editor.js"></script>
    <script src="./raui@0.15.6/button.js"></script>
    <script src="./raui@0.15.6/form.js"></script>
    <script src="./raui@0.15.6/Window.js"></script>
    <script src="./raui@0.15.6/AppBar.js"></script>
    <script src="./raui@0.15.6/Shell.js"></script>
    <script src="./raui@0.15.6/Split.js"></script>
    <script src="./raui@0.15.6/Menu.js"></script>
    <script src="./raui@0.15.6/Popover.js"></script>
    <script src="./raui@0.15.6/Tabs.js"></script>
    <script src="./raui@0.15.6/Table.js"></script>
    <script src="./raui@0.15.6/VirtualList.js"></script>
    <script src="./pouchdb@9.0.0.js"></script>
<style>
  html, body {
    margin: 0;
    padding: 0;
    font-family: sans-serif;
    width: 100%;
    height: 100%;
    box-sizing: border-box;
  }
  #target {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    box-sizing: border-box;
  }
  h1, h2, h3 {
    margin: 0;
    padding: 0 0 0.5em 0;
  }
  fieldset {
    border-color: rgba(128, 128, 128, 0.4);
    border-radius: 0.5em;
  }
  code.expr {
    display: inline-block;
    border: 1px solid rgba(0, 0, 0, 0.2);
    line-height: 1.4em;
    padding: 0.1em;
    vertical-align: text-bottom;
  }
  .content {
    display: flex;
  }
  .hamburger {
    width: 2em;
    height: 2em;
    cursor: pointer;
  }
  .hamburger:after {
    width: 100%;
    height: 100%;
    font-weight: bold;
    font-size: 1.5em;
    content: '\002261';
  }
  #not-connected {
    position: absolute;
    background-color: rgba(0, 0, 0, 0.2);
    width: 100%;
    height: 100%;
    top: 0;
    left: 0;
    position: absolute;
    display: flex;
    align-items: center;
    justify-content: space-around;
    z-index: 100;
    cursor: wait;
  }
  #not-connected .wrapper {
    display: flex;
    flex-direction: column;
  }
  .loader {
    width: 100%;
    height: 100%;
    transform: rotate(-90deg);
    stroke-linecap: round;
    stroke-width: 4;
    fill: none;
    display: block;
    margin: 0 auto;
  }
  .rappbar .loader {
    stroke-width: 10;
  }
  #not-connected .reconnecting {
    margin-top: 1em;
    text-align: center;
    font-weight: bold;
    color: #fff;
    font-size: 1.2rem;
    text-shadow: 0 0 1em #222;
  }
    
  .loader .internal-circle,
  .loader .external-circle {
    stroke: #fff;
    stroke-dashoffset: 0;
    transform-origin: center;
  }
  
  .loader .internal-circle {
    stroke-dasharray: 187;
    animation: internal-circle 1s ease-in-out infinite;
    opacity: .4;
  }
  
  .loader .external-circle {
    stroke-dasharray: 312;
    animation: external-circle 1s linear infinite;
    opacity: .9;
  }

  @keyframes internal-circle {
    0% {
      stroke-dashoffset: 187;
    }
    25% {
      stroke-dashoffset: 80;
    }
    100% {
      stroke-dashoffset: 187;
      transform: rotate(360deg);
    }
  }

  @keyframes external-circle {
    0% {
      stroke-dashoffset: 312;
      transform: rotate(70deg);
    }
    60% {
      stroke-dashoffset: -312;
    }
    100% {
      stroke-dashoffset: -312;
      transform: rotate(450deg);
    }
  }

  .stretch-fields {
    display: flex;
  }
  .stretch-fields > * {
    flex-grow: 1;
  }

  .striped:nth-child(odd), .striped-odd {
    padding: 0.3em;
    box-sizing: border-box;
    border-radius: 0.3em;
  }
  .striped, .striped-even {
    padding: 0.3em;
    box-sizing: border-box;
    border-radius: 0.3em;
  }
  .striped > * {
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .content-wrapper {
    display: flex;
    flex-direction: column;
    flex-grow: 1;
    overflow: auto;
    position: relative;
    padding: 0.5em;
    box-sizing: border-box;
  }

  .version { opacity: 0.5; }

  .field.error {
    color: red !important;
  }

  button.reject {
    color: #fff;
    background-color: #ca3c3c;
  }

  .schema { overflow: auto; }
  .schema-row { padding: 0.2em; position: relative; display: flex; flex-wrap: no-wrap; }
  .table { cursor: pointer; position: sticky; top: 0; z-index: 10; }
  .column .name { padding-left: 1.7em; box-sizing: border-box; }
  .schema-row > * { overflow: hidden; white-space: nowrap; text-overflow: ellipsis; }
  .schema-row .name { width: 55%; }
  .schema-row.table { display: flex; }
  .schema-row.table .name { width: auto; flex-grow: 1; }
  .schema-row.table .details { opacity: 0.5; }
  .schema-row.fn { display: flex; }
  .schema-row.fn .name { width: 20%; cursor: pointer; }
  .schema-row.fn .lang { width: 11%; }
  .schema-row.fn .args { width: 47%; }
  .schema-row.fn .result { width: 22%; }
  .schema-row .name.pkey { font-weight: bold; }
  .schema-row .type { width: 20%; }
  .schema-row .nullable { width: 7%; text-align: center; }
  .schema-row .default { width: 8%; text-align: center; }
  .schema-row .size { width: 10%; }

  .round {
    color: #eee;
    background-color: #444;
    flex-shrink: 0;
    flex-grow: 0;
    height: 1.4em;
    width: 1.4em;
    border-radius: 1.4em;
    flex-shrink: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    line-height: 1em;
    cursor: pointer;
  }

  .fade {
    opacity: 0.5;
    transition: opacity 0.2s ease-in-out;
  }
  .fade:hover {
    opacity: 1;
  }

  th {
    text-align: right;
  }

  .disconnected {
    display: inline-block;
    background-color: #a33;
    color: #fff;
    width: 1em;
    height: 1em;
    border-radius: 1em;
    user-select: none;
    cursor: help;
    text-align: center;
    margin: 0 0.5em;
  }

  .tree-line { height: 1.5em; line-height: 1.5em; }
  .tree-children .back-dots { position: absolute; left: -1px; height: 0.6em; width: 0.75em; border-bottom: 1px dotted; }
  .tree-children .expander { display: inline-block; border: 1px solid; opacity: 0.5; width: 1em; height: 1em; text-align: center; margin-left: 0.25em; margin-right: 0.5em; cursor: pointer; line-height: 1em; }
  .tree-children .name { cursor: pointer; line-height: 1.5em; }
  .tree-children { position: relative; border-left: 1px dotted; margin-left: 0.75em; padding-left: 0.75em; }
  .tree-children:after { content: ' '; position: absolute; display: block; width: 0.75em; height: 0.85em; bottom: 0; left: -0.32em; }
  .tree-children .tree-leaf { height: 1.5em; display: flex; justify-content: space-between; margin-left: 0.5em; border-bottom: 1px solid rgba(128, 128, 128, 0.05); transition: background-color 0.2s ease; }
  .tree-children .tree-leaf:hover { background-color: rgba(128, 128, 128, 0.05); }
  .tree-children .remove-button { cursor: pointer; margin-left: 1em; opacity: 0.5; transition: opacity 0.2s ease; }
  .tree-children .remove-button:hover { opacity: 1; }
</style>
<!-- HEAD -->
<script type=text/ractive id=template>
  {{#if !~/halted || ~/connected}}
    <shell on-init="@.set('@.shell', $1)">
      <right hidden="{{menu.hidden}}" forced="{{menu.forced}}">
        <menu>
          <container>
            <div style="display: flex; align-items: center; justify-content: space-around; height: 3.6em; background-color: {{@style.colors.darker || '#325932'}};">
              <span><a style="color: #eee; text-decoration: none;" href="https://github.com/evs-chris/pg-difficult" target=_blank>pg-difficult</a> <span class=version>- v{{~/status.VERSION || '-client-only'}}</span></span>
            </div>
          </container>
          <item title="Control Panel" on-action="@.host.getWindow('control-panel').raise(true)" />
          <section title="Active Diffs" bind-items="~/diffs" bind-hidden="@global.clientOnly || (~/diffs || []).length < 1" />
          <section title="Monitored Connections" bind-items="~/leaks" bind-hidden="@global.clientOnly || (~/leaks || []).length < 1" />
          <section title="Queries" bind-items="~/queries" bind-hidden="@global.clientOnly || (~/queries || []).length < 1" />
          <section title="Tools" style="margin-top: 1em;">
            <item title="Reload Saved Entries" on-action="@.loadEntries()" />
            <item title="Reload Saved Schema" on-action="@.loadSchema()" />
          </section>
          <section title="Other Windows" style="margin-top: 1em;" bind-items="~/others" bind-hidden="(~/others || []).length < 1" />
        </menu>
      </right>
      <center style="display: flex; flex-direction: column;">
        {{#if !@.host.data.currentMax}}
          <app-bar>
            <left>
              <div style="height: 1.5em; font-size: 1.5em; cursor: pointer; user-select: none; margin-right: 1em;" title="Auto arrange windows" on-click="@.host.placeAll()">&#9638;</div>
              {{#if waiting}}<div style="height: 1.5em;">{{>loader}}</div>{{/if}}
            </left>
            <center><div style="font-size: 1.5em;">{{~/settings.title}}</div></center>
            <right>
              {{#if ~/syncing}}<div style="height: 1.5em; margin-right: 1em;" title="Syncing changes">{{>loader}}</div>{{/if}}
              <div class=hamburger title="Toggle menu" on-click="@.toggle('menu.hidden')" />
            </right>
          </app-bar>
        {{/if}}
        <div style="flex-grow: 1;">
          <host placement=smart on-init="@.set('@.host', $1)">
            <max-top>
              <app-bar>
                <left>{{#if waiting}}<div style="height: 1.5em;">{{>loader}}</div>{{/if}}</left>
                <center>{{window.title}}</center>
                <right>
                  {{>windowControls}}
                  {{#if ~/syncing}}<div style="height: 1.5em; margin-right: 1em;" title="Syncing changes">{{>loader}}</div>{{/if}}
                  <div class=hamburger title="Toggle menu" on-click="@.toggle('menu.hidden')" style="margin-left: 2em;" />
                </right>
              </app-bar>
            </max-top>
          </host>
        </div>
      </center>
    </shell>
    {{#unless ~/connected}}<div id="not-connected">
      <div class=wrapper>
        {{>loader}}
        <div class=reconnecting>Reconnecting...</div>
      </div>
    </div>{{/unless}}
    <input type=file id=file />
  {{else}}
    <div class=html style="width: 100vw; height: 100vh; display: flex; align-items: center; justify-content: center;">
      <h2 style="text-align: center;">
        pg-difficult stopped.<br />
        Please close this window/tab.
      </h2>
    </div>
  {{/if}}
</script>

<script type=text/ractive id=loader>
  <svg class="loader" viewBox="0 0 120 120" xmlns="http://www.w3.org/2000/svg">
    <circle class="internal-circle" cx="60" cy="60" r="30"></circle>
    <circle class="external-circle" cx="60" cy="60" r="50"></circle>
  </svg>
</script>

<script type=text/ractive id=control-panel>
  <tabs pad style="overflow: hidden; height: 100%;">
    <tab title="Connections" hidden="@global.clientOnly">
      <div style="display: flex; align-items: center; justify-content: space-between; padding: 0.3em;">
        <div>Connections are saved in browser storage and can be used to start diffs and run queries.<br/><br/><span style="color: #ca3c3c; font-weight: bold;">WARNING:</span> Starting a diff on a database will create a pgdifficult schema with two tables and a function, and then it will set the function as a trigger for each existing table in the database. A running diff in a database <em>will</em> cause performance degradation, especially if left to collect thousands of changes. You can exclude tables and set maximum captured value size in the connection settings.</div>
        <button style="flex-shrink: 0;" on-click="@.editConnection()" title="Add a saved connection for this browser at this url.">Add Connection</button>
      </div>
      <div style="overflow: auto;">
        {{#each ~/connections}}
          <div class="connection striped">
            <div class="constr">
              <div style="flex-grow: 1;">{{#if .label}}<strong>{{.label}}</strong> ({{constr(.)}}){{else}}{{constr(.)}}{{/if}}<tip>{{`Maximium value length: ${.diffopts.maxlen || 'none'}\nChanged record capture: ${.diffopts.change === 'whole' ? 'both whole records' : .diffopts.change === 'whole-old' ? 'whole old record, new changes' : 'changes only'}\nIgnored tables: ${.diffopts.ignore.length ? .diffopts.ignore.join(', ') : 'none'}`}}</tip></div>
              <div style="width: 13em; flex-shrink: 0;">
                <button class=flat on-click="@.editConnection(.)" {{#if @.hasDiff(.) || @.hasLeak(.)}}disabled title="Stop active watchers to modify this connection"{{else}}title="Edit this saved connection."{{/if}}>Edit</button>
                <button class=flat on-click="@.remove(.)" {{#if @.hasDiff(.) || @.hasLeak(.)}}disabled title="Stop active watchers to modify this connection"{{else}}title="Remove this saved connection."{{/if}}>Remove</button><br/>
              </div>
            </div>
            <div class="actions">
              {{#if !@.hasDiff(.)}}<button on-click="@.startDiff(.)" disabled="{{@.diffWait(.)}}" title="Begin recording changes to tables in this database.">Start Diff</button>
              {{else}}
                <div>
                  <button on-click="@.stopDiff(.)" disabled="{{@.diffWait(.)}}" title="Cease recording changes to tables in this database.">Stop Diff</button>
                  <button on-click="@.entries(.)" title="View recoded entries from this database">Entries</button>
                </div>
              {{/if}}
              {{#if !@.hasLeak(.)}}<button on-click="@.startLeak(.)" title="Begin monitoring connections to this database.">Start Monitor</button>
              {{else}}
                <div>
                  <button on-click="@.stopLeak(.)" title="Cease monitoring connections to this database.">Stop Monitor</button>
                  <button on-click="@.leaks(.)" title="View monitored connecstions to this database">Connections</button>
                </div>
              {{/if}}
              <button on-click="@.query(.)" title="Open a query window to run queries against this database.">Query</button>
              <button on-click="@.schema(.)" title="View this database's schema.">Schema</button>
            </div>
          </div>
        {{else}}
          No connections have been saved.
        {{/each}}
      </div>
    </tab>
    <tab title="Active Diffs" hidden="@global.clientOnly">
      <div style="display: flex; justify-content: space-between; align-items: center;">
        <div style="flex-grow: 1; display: flex;">
          <label as-field style="flex-grow: 1;" title="The segment name groups sets of changes together. The segment will automatically be updated when you stop typing, and any new changes will get the new segment name.">Segment<input value="{{~/newSegment}}" lazy=1500 /></label>
        </div>
        <div>
          <button on-click="@.clear()" title="Remove all recorded changes.">Clear Entries</button>
          <button on-click="@.entries()" title="View all recorded entries in a single combined set.">Combined Entries</button>
          <button on-click="@.addDiff()" title="Start recording changes to an ephemeral connection.">Add Connection</button>
        </div>
      </div>
      <div style="overflow: auto;">
        {{#each Object.values(~/status.clients || {})}}
          <div class="record striped">
            <div class="constr">{{.source}}</div>
            <div class="actions">
              <button on-click="@.query(.config)" title="Open a query widnow to run queries against this database.">Query</button>
              <button on-click="@.schema(.config)" title="View this database's schema.">Schema</button>
              <button on-click="@.entries(.id)" title="View recorded entries from this database.">Entries</button>
              <button on-click="@.stopDiff(.config)" title="Cease recording changes to tables in this database.">Stop Diff</button>
            </div>
          </div>
        {{else}}
          There are no active diffs.
        {{/each}}
      </div>
    </tab>
    <tab title="Connection Monitor" hidden="@global.clientOnly">
      <div style="display: flex; justify-content: space-between; align-items: center;">
        <label as-field>Polling Interval<input type=number value="{{~/status.pollingInterval}}" on-change="@.poll()" lazy></label>
        <div style="flex-grow: 1;">
          The connection monitor polls the server for active connections at a set interval. Connections that appear after the initial connection is made are monitored.
        </div>
        <div style="text-align: right;">
          <button on-click="@.leaks()" title="View monitored connections for all databases.">All Connections</button>
          <button on-click="@.addLeak()" title="Start monitoring connections on an ephemeral connection.">Add Connection</button>
        </div>
      </div>
      <div style="overflow: auto;">
        {{#each Object.values(~/status.leaks || {})}}
          {{#each .databases}}
            <div class="record striped">
              <div class="constr">{{constr(^^/config, { database: . })}}</div>
              <div class=actions>
                <button on-click="@.query(^^/config, .)" title="Open a query widnow to run queries against this database.">Query</button>
                <button on-click="@.leaks(^^/id, .)" title="View monitored connections to this database.">Connections</button>
                <button on-click="@.schema(^^/config, .)" title="View this database's schema.">Schema</button>
                <button on-click="@.stopLeak(^^/config, .)">Stop Monitor</button>
              </div>
            </div>
          {{/each}}
        {{else}}
          There are no active connection monitors.
        {{/each}}
      </div>
    </tab>
    <tab title="Saved Queries" hidden="@global.clientOnly">
      <div style="padding: 0.3em; display: flex; justify-content: space-between; align-items: center; min-height: 2.75em;">
        <span>Queries are saved in browser storage. Click a query to make it available to load in a query window.</span>
        {{#if ~/loadedQuery}}<button on-click="@.set('loadedQuery', undefined)">Cancel</button>{{/if}}
      </div>
      <div style="overflow: auto;">
        {{>node ~/queryTree}}
      </div>
    </tab>
    <tab title="Reports">
      <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.3em;">
        <div style="padding: 0.3em;">Reports can be set up to run against a Diff, a Schema, a Provided Result from querying multiple database, a Query for multiple database, a Query for a single database, or a JSON blob. Query-based reports can be managed from the Host Explorer.</div>
        <div style="flex-shrink: 0;"><button title="Open a new report designer." on-click="@.open({ type: 'report' })">New Designer</button></div>
      </div>
      <div style="overflow: auto;">
        {{#partial leaf}}
          <div class=back-dots /><div class=tree-leaf><span class=name {{#if .value.host}}style="cursor: not-allowed;" title="This report utilizes SQL query sources, making it only accessible from a Host Explorer."{{else}}on-click="@.open(.value)"{{/if}}>{{.name}}</span> <span style="line-height: 1.5em;">{{.value.kind}} <span class=remove-button title="Remove this {{.value.type}}." on-click="@.remove(.value)">&times;</span></span></div>
        {{/partial}}
        {{>node ~/reportTree}}
      </div>
    </tab>
    <tab title="Scratch Pads">
      <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.3em;">
        <div style="padding: 0.3em;">Scratch pads are a place to write bits of text that are automatically saved to browser local storage when they are edited.</div>
        <div style="flex-shrink: 0;"><button title="Open a new scratch pad." on-click="@.open({ type: 'scratch' })">New Scratch Pad</button></div>
      </div>
      <div style="overflow: auto;">
        {{>node ~/scratchPadTree}}
      </div>
    </tab>
    <tab title="Settings">
      <div style="display: flex; flex-direction: column;">
        <fieldset>
          <legend>Client Options</legend>
          <label as-field>Theme<select value="{{~/store.settings.theme}}">
            <option value="{{undefined}}">Auto</option>
            <option value="dark">Dark</option>
            <option value="light">Light</option>
          </select></label>
          <label as-field>Scale <tip>Mobile browsers and even some desktops have default scaling that's just not right for every case. Some browsers force the zoom level to be global, and that makes for unpleasantness elsewhere. You can set your zoom level in percent for just pg-difficult here, because life is just better when you can change the scale of stuff at will.</tip><input type=number min=25 max=400 value="{{~/store.settings.scale}}" lazy placeholder=100 /></label>
          <label as-field>Color <tip>If you are running multiple instances or have multiple storage namespaces e.g. 127.0.0.1:1999 and localhost:1999 and want to be able to visually distinguish them, you can select different colors here to make it a little more obvious which one you're looking at if you can remember which color goes with which instance.</tip><select value="{{~/store.settings.color}}">
            <option value="{{undefined}}">The Default&trade;</option>
            <option value="black">Black</option>
            <option value="blue">Blue</option>
            <option value="gray">Gray</option>
            <option value="green">Green</option>
            <option value="orange">Orange</option>
            <option value="pink">Pink</option>
            <option value="purple">Purple</option>
            <option value="red">Red</option>
            <option value="teal">Teal</option>
            <option value="yellow">Yellow</option>
          </select></label>
          <label as-field>Title <tip>Set the title for clients attached to this namespace, for the same reasons you may want to set a different color.</tip><input value="{{~/store.settings.title}}" /></label>
          <label as-field>Paste Timeout ms <tip>Some actions, like clicking on an evaluated result in a raport scratch pad, will automatically copy the value to the clipboard and an internal storage area tha can be accessed by other tools, like the local diff tool. These tools will offer to load the value just copied with a click for a limited amount of time. This is that limit.</tip><input type=number placeholder=10000 step=1000 value="{{~/store.settings.pasteTimeout}}" /></label>
        </fieldset>
        <fieldset style="margin-top: 1em;">
          <legend>Diff Entries Options</legend>
          {{#if !@global.clientOnly}}
            <label as-field class=inline><input type=checkbox bind-checked="~/store.settings.allowUndoSegment" /> Enable undoing diff segments by default?</label>
            <label as-field class=inline><input type=checkbox bind-checked="~/store.settings.allowUndoSingle" /> Enable undoing individual diff entries by default?</label>
          {{/if}}
          <label as-field class=inline><input type=checkbox bind-checked="~/store.settings.hideBlankFields" /> Hide empty string fields in diff records by default?</label>
          <label as-field class=inline><input type=checkbox bind-checked="~/store.settings.hideDefaultFields" /> Hide defaulted fields in diff records by default?</label>
        </fieldset>
        {{#if !@global.clientOnly}}
          <fieldset style="margin-top: 1em;">
            <legend>Query Options</legend>
            <label as-field class=inline><input type=checkbox bind-checked="~/store.settings.queryOrderColumns" /> Order query result columns alphabetically?</label>
          </fieldset>
        {{/if}}
        <fieldset style="margin-top: 1em;">
          <legend>Editor Options</legend>
          <label as-field class=inline><input type=checkbox checked="{{~/store.settings.editor.wrap}}" /> Word wrap?</label>
          <label as-field class=inline><input type=checkbox checked="{{~/store.settings.editor.lineNumbers}}" /> Show line numbers?</label>
          {{#if ~/store.settings.editor.lineNumbers}}<label as-field class=inline><input type=checkbox checked="{{~/store.settings.editor.relativeLineNumbers}}" /> Relative line numbers?</label>{{/if}}
          <label as-field class=inline><input type=checkbox checked="{{~/store.settings.editor.highlightActive}}" /> Highlight active line?</label>
          <label as-field class=inline><input type=checkbox checked="{{~/store.settings.editor.highlightSelected}}" /> Highlight selected word?</label>
          <label as-field class=inline><input type=checkbox checked="{{~/store.settings.editor.printMargin}}" /> Show print margin?</label>
          <label as-field class=inline><input type=checkbox twoway=false checked="{{~/store.settings.editor.softTabs}}" /> Use soft tabs?</label>
          <div class=break />
          <label as-field>Input Mode<select value="{{~/store.settings.editor.keymode}}">
            <option value="{{undefined}}">default</option>
            <option>emacs</option>
            <option>sublime</option>
            <option>vim</option>
            <option>vscode</option>
          </select></label>
          <label as-field>Light Theme <tip>The Ace editor theme to use when retinal pain mode is selected.</tip><select value="{{~/store.settings.editor.lightTheme}}">{{>ace-themes}}</select></label>
          <label as-field>Dark Theme <tip>The Ace editor theme to use when the correct mode is selected.</tip><select value="{{~/store.settings.editor.darkTheme}}">{{>ace-themes}}</select></label>
          <label as-field>Tab Size<input type=number placeholder=2 value="{{~/store.settings.editor.tabSize}}" /></label>
          <label as-field>Autosave Timeout MS<tip>The number of milliseconds after a change is made to wait before triggering a save of the content. For editors that don't have a save action, this will do nothing. -1 will disable autosave. The default is 15000 (15 seconds).</tip><input type=number value="{{~/store.settings.editor.autosave}}" placeholder=15000 lazy /></label>
        </fieldset>
        {{#if !@global.clientOnly}}
          <fieldset style="margin-top: 1em;">
            <legend>Delimited Text Options</legend>
            <label as-field title="The delimiter to use between fields when rendering a data set as delimited text e.g. , (comma), \t (tab), | (pipe). Defaults to ,">Field Delimiter<input value="{{~/store.settings.csv.field}}" placeholder="," /></label>
            <label as-field title="The delimiter to use between records when rendering a data set as delimited text e.g. \n (line feed), \r (carriage return), \r\n (carriage return, line feed). Defaults to \n">Record Delimiter<input value="{{~/store.settings.csv.record}}" placeholder="\n" /></label>
            <label as-field title="The quote to use around fields when rendering a data set as delimited text e.g. ' (single quote), &quot; (double quote), $$ (dollar, dollar). Defaults to none">Field Quote<input value="{{~/store.settings.csv.quote}}" /></label>
          </fieldset>
        {{/if}}
        <fieldset style="margin-top: 1em;">
          <legend>Local Diff Options</legend>
          <label as-field>Default Left Mode<select value="{{~/store.settings.diff.leftview}}"><option value="{{undefined}}">tree</option><option>text</option></select></label>
          <label as-field>Default Right Mode<select value="{{~/store.settings.diff.rightview}}"><option value="{{undefined}}">tree</option><option>text</option></select></label>
          <!--<label as-field>Default Value Format<select value="{{~/store.settings.diff.format}}"><option value="{{undefined}}">raport</option><option>json</option></select></label>-->
        </fieldset>
        <fieldset style="margin-top: 1em;">
          <legend>Sync Servers <tip>Local data can by configured to sync with CouchDB and PouchDB servers.</tip></legend>
          <div style="display: flex; align-items: center; justify-content: space-between;">
            <span>Sync settings are stored in browser local storage, which is scoped to the URL in the address bar.</span>
            <button on-click="@.push('sync.servers', {})">Add Server</button>
          </div>
          {{#each sync.servers}}
            <div class="striped {{@index % 2 == 0 ? 'striped-even' : 'striped-odd'}}">
              <label as-field>Protocol<select value="{{.protocol}}" on-change="@context.set('valid', false)"><option>https</option><option>http</option></select></label>
              <label as-field>Host<input value="{{.host}}" on-change="@context.set('valid', false)" /></label>
              <label as-field>Port<input type="number" value="{{.port}}" on-change="@context.set('valid', false)" /></label>
              <label as-field>Database<input value="{{.db}}" on-change="@context.set('valid', false)" /></label>
              <label as-field>Username<input value="{{.user}}" on-change="@context.set('valid', false)" /></label>
              <label as-field>Password<input type="password" value="{{.password}}" on-change="@context.set('valid', false)" /></label>
              <fieldset>
                <legend>Sync Categories</legend>
                <label as-field><input type=checkbox name="{{.types}}" value="settings" /> Settings</label>
                <label as-field><input type=checkbox name="{{.types}}" value="connection" /> Connections</label>
                <label as-field><input type=checkbox name="{{.types}}" value="query" /> Queries</label>
                <label as-field><input type=checkbox name="{{.types}}" value="report" /> Reports</label>
                <label as-field><input type=checkbox name="{{.types}}" value="scratch" /> Scratch Pads</label>
              </fieldset>
              {{#if !.valid}}
                <label as-field><button on-click="@.validateSync(@keypath)">Validate</button>
              {{else}}
                <label as-field><button class=flat disabled>Valid</button>
              {{/if}}
              <label as-field><button on-click="@context.splice('../', @index, 1)">Remove</button>
            </div>
          {{/each}}
        </fieldset>
        <div style="margin-top: 1em;">
          <button on-click="@.exportSettings()">Export Settings</button>
          <button on-click="@.importSettings()">Import Settings</button>
        </div>
      </div>
    </tab>
  </tabs>
  <buttons>
    {{#unless @global.clientOnly}}
      <button left title="Open a new Host Explorer window to browse databases on all connections, view schema, query across multiple databases, and run reports." on-click="@.exploreHosts()">Host Explorer</button>
      <button class=reject on-click="@.halt()">Stop pg-difficult</button>
    {{/unless}}
    <button left title="Open a new two-way diff window for local data." on-click="@.localDiff()">Local Diff</button>
    <button left title="Open a new evaluation pad for calculations or inspecting data." on-click="@.evalPad()">Eval Pad</button>
  </buttons>
  {{#partial node}}
    <div class=tree-line>{{#if .name}}<div class=back-dots /><span class=expander on-click="@context.toggle('.expand')">{{.expand ? '-' : '+'}}</span> <span class=name on-click="@context.toggle('.expand')"> {{.name}}/</span>{{else}}<span style="display: inline-block; width: 0.5em;" /> <span>{{.name}}/{{/if}}</div>
    {{#if .expand}}
      <div class=tree-children>
        {{#each .nodes}}{{>.type}}{{/each}}
      </div>
    {{/if}}
  {{/partial}}
  {{#partial leaf}}
    <div class=back-dots /><div class=tree-leaf><span class=name on-click="@.open(.value)">{{.name}}</span> <span style="line-height: 1.5em;">{{.value.syntax}} <span class=remove-button title="Remove this scrath pad." on-click="@.remove(.value)">&times;</span></span></div>
  {{/partial}}
  {{#partial ace-themes}}
    <option value="{{undefined}}">The Default&trade;</option>
    <option>ambiance</option>
    <option>chrome</option>
    <option>cloud9_day</option>
    <option>cloud9_night</option>
    <option>cloud_editor</option>
    <option>cloud_editor_dark</option>
    <option>clouds</option>
    <option>clouds_midnight</option>
    <option>cobalt</option>
    <option>crimson_editor</option>
    <option>dawn</option>
    <option>dracula</option>
    <option>dreamweaver</option>
    <option>eclipse</option>
    <option>github</option>
    <option>github_dark</option>
    <option>github_light_default</option>
    <option>gob</option>
    <option>gruvbox</option>
    <option>gruvbox_dark_hard</option>
    <option>gruvbox_light_hard</option>
    <option>idle_fingers</option>
    <option>iplastic</option>
    <option>katzenmilch</option>
    <option>kr_theme</option>
    <option>kuroir</option>
    <option>merbivore</option>
    <option>merbivore_soft</option>
    <option>mono_industrial</option>
    <option>monokai</option>
    <option>nord_dark</option>
    <option>one_dark</option>
    <option>pastel_on_dark</option>
    <option>solarized_dark</option>
    <option>solarized_light</option>
    <option>sqlserver</option>
    <option>terminal</option>
    <option>textmate</option>
    <option>tomorrow</option>
    <option>tomorrow_night</option>
    <option>tomorrow_night_blue</option>
    <option>tomorrow_night_bright</option>
    <option>tomorrow_night_eighties</option>
    <option>twilight</option>
    <option>vibrant_ink</option>
    <option>xcode</option>
  {{/partial}}
</script>

<script type=text/ractive id=query>
  <div style="border-bottom: 1px solid; display: flex; justify-content: space-between; align-items: center;">
    <button on-click="@.runQuery(~/loaded ? ~/loaded.sql : ~/query)" title="Execute this query and return the result. (ctrl+Enter){{'\n\n'}}Highlight text to execute only the highlighted portion as a query.">Run</button>
    <label as-field class=inline><input type=checkbox bind-checked="~/settings.queryOrderColumns" /> Order query result columns alphabetically?</label>
    {{#if ~/loadedQuery}}
      <button on-click="@.loadQuery(~/loadedQuery)" title="Load the selected saved query in this window.">Load Query</button>
    {{else}}
      <div style="display: flex; align-items: center;">
        {{#if ~/loaded.sql || ~/query}}<button on-click="@.saveQuery()" title="Save this query to the control panel Saved Queries.">Save</button>{{/if}}
        {{#if ~/loaded.name}}<button on-click="@.loadQuery()" title="This query is currently saved as {{~/loaded.name}}. Click here to disconnect this query from that named query. When the query is disconnected, it may be saved with a different name.">Unload</button>{{/if}}
      </div>
    {{/if}}
    {{#if ~/result.length}}
      <button title="Download this query result as delimited text (csv/tsv). shit+click to make this result data available to raport scratch pads as *query" on-click="@event.shiftKey ? [appSet('scratchroot.sources.query', { value: ~/result }), @.host.toast('Results are now available to raport scratch pads as *query.', { type: 'info', timeout: 3000 })] : @.downloadQuery(~/result)">Download</button>
    {{/if}}
  </div>
  <div class="query" style="position: relative;">
    <split>
      <div size=20 class="query-text" as-tracked=`ace` as-ace="{ bind: ~/loaded ? '~/loaded.sql' : '~/query', syntax: 'pgsql', theme: @style.theme == 'dark' ? (~/editor.darkTheme || 'tomorrow_night_eighties') : (~/editor.lightTheme || 'tomorrow'), wrap: ~/editor.wrap, highlightActive: ~/editor.highlightActive, fontSize: '1em', font: 'monospace', printMargin: ~/editor.printMargin, keymode: ~/editor.keymode, lineNumbers: ~/editor.lineNumbers, relativeLineNumbers: ~/editor.relativeLineNumbers, highlightSelected: ~/editor.highlightSelected, softTabs: ~/editor.softTabs, tabSize: ~/editor.tabSize }" on-keydown="@event.ctrlKey && @event.key === 'Enter' ? @.runQuery(~/loaded ? ~/loaded/sql : ~/query) : true" />
      <div class="result">
        <data-table auto-titles no-wrap fixed-header allow-select=false on-init="@.set('@.table', $1)" items="{{~/result}}">
          <bottom>
            <div style="display:flex; justify-content: space-between;">
              <span>{{#if !~/result.length && ~/affected != null}}{{~/affected}} rows affected.{{/if}} {{#unless ~/error}}{{~/result.length || 'No'}} rows{{#if ~/result.length}}, {{@.table.data.columns.length}} cols{{/if}}{{/unless}}</span>
              <span>{{#if ~/runtime != null}}Completed in {{~/runtime}}ms{{/if}}</span>
            </div>
          </bottom>
        </data-table>
      </div>
    </split>
  </div>
</script>

<script type=text/ractive id=entries>
  <div class="content-wrapper">
    <div class="controls">
      {{#if @.source && !~/loaded}}
        <label as-field title="The segment name groups sets of changes together. The segment will automatically be updated when you stop typing, and any new changes will get the new segment name.">Segment<input value="{{~/newSegment}}" lazy=1500 /></label>
      {{/if}}
      <label class=filter class-error="~/exprError" as-field title="Raport expression used to filter out entries. Available fields are id, new, old, schema, segment, source, stamp, and table. new and old are objects containing the fields that changed in the record. table, schema, source, and segment are strings.{{#if ~/exprError}}{{'\n\nError: ' + ~/exprError.message + '\n' + ~/exprError.marked}}{{/if}}">Filter Expression<input value="{{expr}}" lazy=1000 /></label>
      <button as-pop=`~/showSettings`>&#9881;</button>
    </div>
    <virtual-list bind-items="~/entries" size=75>
      <header>
        {{#if .segment}}
          <div class=header><h2 title="Double click to rename segment" on-dblclick="@.renameSegment(.), false">{{.segment}}</h2> <div class=buttons style="padding-top: 0.9em;">{{#if ~/allowUndoSegment}}<button class=undo on-click="@.undoSegment(.), false" title="Undo all changes in this segment by replaying the changes in reverse. This will also create a new segment named 'Undo {{.segment}}', unless you hold the ctrl key when clicking this button.">Undo</button>{{/if}}</div></div>
        {{/if}}
      </header>
      {{#with . as record, @.details(.) as entry}}
        {{#if entry.status}}
          {{#if entry.changed}}
            <div class="wrapper striped-{{index % 2 == 0 ? 'even' : 'odd'}}" on-click="@event.shiftKey ? copyToClipboard(record.old || {}, 'Copied old record JSON to clipboard.') : copyToClipboard(Object.keys(record.new).length !== Object.keys(record.old).length ? Object.assign({}, record.old, record.new) : record.new || {}, 'Copied new record JSON to clipboard.'), false">
              <div class=name><span>{{record.table}} {{entry.id || ''}} {{entry.status}}</span><span class=src>({{record.source}})</span></div>
              {{#each entry.changed}}
                <div class="diff">
                  <div class="name">{{this.0}}</div>
                  <div class="left" on-click="copyToClipboard(this.1.0, 'Copied value to clipboard.'), false">{{typeof this.1.0 === 'object' ? JSON.stringify(this.1.0) : this.1.0}}</div>
                  <div class="right" on-click="copyToClipboard(this.1.1, 'Copied value to clipboard.'), false">{{typeof this.1.1 === 'object' ? JSON.stringify(this.1.1) : this.1.1}}</div>
                </div>
              {{/each}}

              <div class=buttons>
                {{#if ~/allowUndoSingle}}<button class=undo on-click="@.undoSingle(record), false" title="Undo this change by running the inverse of the statment that created the change.">Undo</button>{{/if}}
                <button class=split-up title="Split this entry and all entries above it up to the previous segment into a new segment" on-click="@.renameSegment(record, 'above'), false">&#9650;</button> <button class=split-down title="Split this entry and all entries below it down to the next segment into a new segment" on-click="@.renameSegment(record, 'below'), false">&#9660;</button>
              </div>
            </div>
          {{else}}
            <div class="diff whole striped-{{index % 2 == 0 ? 'even' : 'odd'}}" on-click="@event.shiftKey ? copyToClipboard(record.old || {}, 'Copied old record JSON to clipboard.') : copyToClipboard(record.new || {}, 'Copied new record JSON to clipboard.'), false">
              <div class=name><span>{{record.table}} {{entry.id || ''}} {{entry.status}}</span><span class=src>({{record.source}})</span></div>
              {{#each entry.record}}
                <div class="entry"><div class="key">{{this.0}}</div><div class="value" on-click="copyToClipboard(this.1, 'Copied value to clipboard.'), false">{{typeof this.1 === 'object' ? JSON.stringify(this.1) : this.1}}</div></div>
              {{/each}}

              <div class=buttons>
                {{#if ~/allowUndoSingle}}<button class=undo on-click="@.undoSingle(record), false" title="Undo this change by running the inverse of the statment that created the change.">Undo</button>{{/if}}
                <button class=split-up title="Split this entry and all entries above it up to the previous segment into a new segment" on-click="@.renameSegment(record, 'above'), false">&#9650;</button> <button class=split-down title="Split this entry and all entries below it down to the next segment into a new segment" on-click="@.renameSegment(record, 'below'), false">&#9660;</button>
              </div>
            </div>
          {{/if}}
        {{else}}
          <div class="wrapper striped-{{index % 2 == 0 ? 'even' : 'odd'}}" on-click="@event.shiftKey ? copyToClipboard(record.old || {}, 'Copied old record JSON to clipboard.') : copyToClipboard(record.new || {}, 'Copied new record JSON to clipboard.'), false">
            <div class=name><span>{{record.table}} {{entry.id || ''}} {{entry.status || '(empty changeset)'}}</span><span class=src>({{record.source}})</span></div>
            <div class=buttons>
              <button class=split-up title="Split this entry and all entries above it up to the previous segment into a new segment" on-click="@.renameSegment(record, 'above'), false">&#9650;</button> <button class=split-down title="Split this entry and all entries below it down to the next segment into a new segment" on-click="@.renameSegment(record, 'below'), false">&#9660;</button>
            </div>
          </div>
        {{/if}}
      {{/with}}
      {{#if ~/entries[index + 1] && ~/entries[index + 1].segment !== .segment}}{{#with ~/entries[index + 1]}}
        <div class=header><h2 title="Double click to rename segment" on-dblclick="@.renameSegment(.), false">{{.segment}}</h2> <div class=buttons style="padding-top: 0.9em;">{{#if ~/allowUndoSegment}}<button class=undo on-click="@.undoSegment(.), false" title="Undo all changes in this segment by replaying the changes in reverse. This will also create a new segment named 'Undo {{.segment}}', unless you hold the ctrl key when clicking this button.">Undo</button>{{/if}}</div></div>
      {{/with}}{{/if}}
      <else>
        {{#if ~/exprError}}<code class=expr>{{~/expr}}</code> is an invalid filter.<br /><br /><pre>Error: {{~/exprError.message + '\n\n'}}{{~/exprError.marked}}</pre>{{else}}No change entries have been recorded.{{/if}}
      </else>
    </virtual-list>
  </div>
  <pop bind-popped="~/showSettings" where="below" align="end" tail>
    <div style="width: 26em; display: flex; flex-direction: column;">
      {{#if @.source && !~/loaded}}
        <label class=inline as-field title="Check to enable undoing segments"><input type=checkbox bind-checked="~/allowUndoSegment" /> Undo segments?</label>
        <label class=inline as-field title="Check to enable undoing individual entries"><input type=checkbox bind-checked="~/allowUndoSingle" /> Undo single?</label>
      {{/if}}
      {{#if schemas}}
        <label class=inline as-field title="Check to hide empty string fields in entries"><input type=checkbox bind-checked="~/hideBlankFields" /> Hide blank?</label>
        <label class=inline as-field title="Check to hide fields with default values in entries"><input type=checkbox bind-checked="~/hideDefaultFields" /> Hide default?</label>
      {{/if}}
      {{#unless (@.source && !~/loaded) && schemas}}
        <div />
      {{/unless}}
    </div>
    <div style="display: flex; justify-content: space-between;">
      {{#if ~/entries.length}}
        <button class=reject on-click="@.clearEntries()" title="Remove recorded entries {{#if !~/loaded && !@.source}}for all diffs{{else}}for only this diff. Hold the ctrl key and click to clear all diff entries.{{/if}}.">Clear Entries</button>
      {{else}}
        <div />
      {{/if}}
      {{#if ~/entries.length}}
        <button class=download on-click="@.download()" title="Download a file containing these entries. Hold the ctrl key while clicking to open a popup window of the HTML. Hold the shift key while clicking to download the HTML directly.">Download</button>
      {{else}}
        <div />
      {{/if}}
    </div>
  </pop>
</script>

<script type=text/ractive id=entries-text>
  <div class=content-wrapper>
  {{#each ~/entries as record}}{{#with @.details(record) as entry}}
    {{#if @index === 0 || ~/entries[@index - 1].segment !== .segment}}<div class=header><h2>{{.segment}}</h2></div>{{/if}}
    {{#if entry.status}}
      {{#if entry.changed}}
        <div class="wrapper striped">
          <div class=name><span>{{record.table}} {{entry.id || ''}} {{entry.status}}</span><span class=src>({{record.source}})</span></div>
          {{#each entry.changed}}
            <div class="diff">
              <div class="name">{{this.0}}</div>
              <div class="left">{{typeof this.1.0 === 'object' ? JSON.stringify(this.1.0) : this.1.0}}</div>
              <div class="right">{{typeof this.1.1 === 'object' ? JSON.stringify(this.1.1) : this.1.1}}</div>
            </div>
          {{/each}}
        </div>
      {{else}}
        <div class="diff whole striped">
          <div class=name><span>{{record.table}} {{entry.id || ''}} {{entry.status}}</span><span class=src>{{record.source}}</span></div>
          {{#each entry.record}}
            <div class="entry"><div class="key">{{this.0}}</div><div class="value">{{typeof this.1 === 'object' ? JSON.stringify(this.1) : this.1}}</div></div>
          {{/each}}
        </div>
      {{/if}}
    {{/if}}
  {{/with}}{{else}}
    No change entries have been recorded.
  {{/each}}
  </div>
</script>

<script type=text/ractive id=leaks>
  {{#partial leak}}
    <div>Updated {{age(~/status.lastUpdate)}}</div>
    <div class="leak header">
      <div class=user>User</div>
      <div class=application>Application</div>
      <div class=client>Client</div>
      <div class=state>State</div>
      <div class=started>Started</div>
      <div class=constr>Connection</div>
      <div class=pid>Process ID</div>
    </div>
    {{#each leaks}}
      <div class="leak striped">
        <div class=user>{{.user}}</div>
        <div class=application>{{.application}}</div>
        <div class=client>{{.client}}</div>
        <div class=state>{{.state}}</div>
        <div class=started title="{{.started}}">{{age(.started)}}</div>
        <div class=constr>{{.source}}</div>
        <div class=pid>{{.pid}}</div>
      </div>
    {{else}}
      No connections.
    {{/each}}
  {{/partial}}
  <tabs style="overflow: hidden;" no-pad>
    <tab title="Added">
      <div class=content-wrapper>{{>leak leaks as leaks}}</div>
    </tab>
    <tab title="Current" defer>
      <div class=content-wrapper>{{>leak current as leaks}}</div>
    </tab>
    <tab title="Initial" defer>
      <div class=content-wrapper>{{>leak initial as leaks}}</div>
    </tab>
  </tabs>
</script>

<script type=text/ractive id=schema>
  <div class=content-wrapper>
    {{#with ~/entries as entries, ~/schema as _schema, @.config as _config}}
      {{>schema-inner}}
    {{/with}}
  </div>
</script>

<script type=text/ractive id=schema-inner>
  <tabs style="height: calc(100% - 2px); margin-top: 2px;">
    <tab title=Tables>
      <virtual-list bind-items="tables" size=34 style="flex-grow: 1;">
        <header>
          <div style="position: relative;">
            <div style="border-bottom: 1px solid;">
              <div class="stretch-fields">
                <label as-field>Search<input value="{{~/schemafilter}}" lazy=500 /></label>
                <label as-field title="Available fields are column.{name, default, enum, type, pgtype, nullable, length, precision, pkey, schema, table, description}">Expression<input value="{{~/schemaexpr}}" lazy=500 /></label>
                {{#if !~/compareSchema || ~/compareSchema.schema !== _schema}}
                  <label as-field style="flex-grow: 0;"><button on-click="@.compareSchema(_schema, _config)" title="Compare this schema to another database's schema.">Compare</button></label>
                {{else}}
                  <label as-field style="flex-grow: 0;"><button on-click="@.set('compareSchema', undefined)" title="Cancel waiting for another schema to be selected to compare to this schema.">Cancel</button></label>
                {{/if}}
                <label as-field style="flex-grow: 0;"><button on-click="@event.shiftKey ? [appSet('scratchroot.sources.schema', { value: _schema }), @.host.toast('This schema is now available to raport scratch pads as *schema.', { type: 'info', timeout: 3000 })] : @.downloadSchema(_schema)" title="Download a file containing this schema. shift+click to expose this schema as *schema to any raport scratch pads.">Download</button></label>
              </div>
              <div class="schema-row" style="font-weight: bold;">
                <div class="name" style="cursor: pointer;" title="Click to sort columns by {{~/schemasort === 'position' ? 'name' : 'position'}}" on-click="@.set('schemasort', ~/schemasort === 'position' ? 'name' : 'position')">Name ({{~/schemasort === 'position' ? '#' : 'A'}})</div>
                <div class="nullable">Null</div>
                <div class="default">Default</div>
                <div class="type">Type</div>
                <div class="size">Size</div>
              </div>
            </div>
            {{#if index && schemaexpanded.table[escapeKey(.table || .name)]}}
              <div class="schema-row table sticky-header" style="position: absolute; padding: 0.5em; width: 100%; box-sizing: border-box; top: auto;" on-click="@.toggle('schemaexpanded.table.' + escapeKey(.table || .name))" style-z-index="{{index + 1}}">
                <div class="name">{{.table || .name}}</div>
                <div class="details">({{@.colsFor(.table || .name, 'tables')}} cols{{#if ~/schemafilter || ~/schemaexpr}}, {{~/schemaMatches.tables[.table || .name].length}} match{{/if}})</div>
              </div>
            {{/if}}
          </div>
        </header>
        <item class="striped-{{index % 2 ? 'odd' : 'even'}}" {{#if !.table}}style="position: relative; z-index: {{index}};"{{/if}}>
          {{#if !.table}}
            <div class="schema-row table" on-click="@.toggle('schemaexpanded.table.' + escapeKey(.name))">
              <div class="name" {{#if .description}}title="{{.description}}"{{/if}}>{{.name}}</div>
              <div class="details">({{.columns.length}} cols{{#if ~/schemafilter || ~/schemaexpr}}, {{~/schemaMatches.tables[.name].length}} match{{/if}})</div>
            </div>
          {{else}}
            <div class="schema-row column">
              <div class="name {{#if .pkey}}pkey{{/if}}" {{#if .description}}title="{{.description}}"{{/if}}>
                <div class=expand-indicator class-expanded class-matched />
                {{.name}}
              </div>
              <div class="nullable">{{.nullable ? 'Y' : 'N'}}</div>
              <div class="default" {{#if .default}}title="{{.default}}"{{/if}}>{{.default ? 'Y' : 'N'}}</div>
              <div class="type" {{#if .enum}}title="Values: {{.enum.join(', ')}}"{{/if}}>{{.pgtype}}</div>
              <div class="size">{{#if .length != null}}{{.length}}{{elseif .precision != null}}{{.precision}}{{/if}}</div>
            </div>
          {{/if}}
        </item>
        <else>
          <div class="schema-row">
            No {{#if ~/schemafilter || ~/schemaexpr}}matching{{/if}} tables or columns.
          </div>
        </else>
      </virtual-list>
      <div style="padding: 0.5em; border-top: 1px solid;">
        {{_schema.tables.length}} tables, {{@.colCount(_schema, 'tables')}} columns{{#if ~/schemafilter || ~/schemaexpr}}, {{@.schemaMatchCount(~/schemaMatches.tables)}} match{{/if}}
      </div>
    </tab>
    <tab title=Views>
      <virtual-list bind-items="views" size=34 style="flex-grow: 1;">
        <header>
          <div style="position: relative;">
            <div style="border-bottom: 1px solid;">
              <div class="stretch-fields">
                <label as-field>Search<input value="{{~/schemafilter}}" lazy=500 /></label>
                <label as-field title="Available fields are column.{name, default, enum, type, pgtype, nullable, length, precision, pkey, schema, table}">Expression<input value="{{~/schemaexpr}}" lazy=500 /></label>
                {{#if !~/compareSchema || ~/compareSchema.schema !== _schema}}
                  <label as-field style="flex-grow: 0;"><button on-click="@.compareSchema(_schema, _config)" title="Compare this schema to another database's schema.">Compare</button></label>
                {{else}}
                  <label as-field style="flex-grow: 0;"><button on-click="@.set('compareSchema', undefined)" title="Cancel waiting for another schema to be selected to compare to this schema.">Cancel</button></label>
                {{/if}}
                <label as-field style="flex-grow: 0;"><button on-click="@.downloadSchema(_schema)" title="Download a file containing this schema.">Download</button></label>
              </div>
              <div class="schema-row" style="font-weight: bold;">
                <div class="name" style="cursor: pointer;" title="Click to sort columns by {{~/schemasort === 'position' ? 'name' : 'position'}}" on-click="@.set('schemasort', ~/schemasort === 'position' ? 'name' : 'position')">Name ({{~/schemasort === 'position' ? '#' : 'A'}})</div>
                <div class="nullable">Null</div>
                <div class="default">Default</div>
                <div class="type">Type</div>
                <div class="size">Size</div>
              </div>
            </div>
            {{#if index && schemaexpanded.view[escapeKey(.table || .name)]}}
              <div class="schema-row table sticky-header" style="position: absolute; padding: 0.5em; width: 100%; box-sizing: border-box; top: auto;" on-click="@.toggle('schemaexpanded.view.' + escapeKey(.table || .name))" style-z-index="{{index + 1}}">
                <div class="name">{{.table || .name}}</div>
                <div class="details">({{@.colsFor(.table || .name, 'views')}} cols{{#if ~/schemafilter || ~/schemaexpr}}, {{~/schemaMatches.tables[.table || .name].length}} match{{/if}})</div>
              </div>
            {{/if}}
          </div>
        </header>
        <item class="striped-{{index % 2 ? 'odd' : 'even'}}" {{#if !.table}}style="position: relative; z-index: {{index}};"{{/if}}>
          {{#if !.table}}
            <div class="schema-row table" on-click="@.toggle('schemaexpanded.view.' + escapeKey(.name))">
              <div class="name" {{#if .description}}title="{{.description}}"{{/if}}>{{.name}}</div>
              <div class="details">({{.columns.length}} cols{{#if ~/schemafilter || ~/schemaexpr}}, {{~/schemaMatches.views[.name].length}} match{{/if}})</div>
            </div>
          {{else}}
            <div class="schema-row column">
              <div class="name {{#if .pkey}}pkey{{/if}}" {{#if .description}}title="{{.description}}"{{/if}}>
                <div class=expand-indicator class-expanded class-matched />
                {{.name}}
              </div>
              <div class="nullable">{{.nullable ? 'Y' : 'N'}}</div>
              <div class="default" {{#if .default}}title="{{.default}}"{{/if}}>{{.default ? 'Y' : 'N'}}</div>
              <div class="type" {{#if .enum}}title="Values: {{.enum.join(', ')}}"{{/if}}>{{.pgtype}}</div>
              <div class="size">{{#if .length != null}}{{.length}}{{elseif .precision != null}}{{.precision}}{{/if}}</div>
            </div>
          {{/if}}
        </item>
        <else>
          <div class="schema-row">
            No {{#if ~/schemafilter || ~/schemaexpr}}matching{{/if}} views or columns.
          </div>
        </else>
      </virtual-list>
      <div style="padding: 0.5em; border-top: 1px solid;">
        {{_schema.views.length}} views, {{@.colCount(_schema, 'views')}} columns{{#if ~/schemafilter || ~/schemaexpr}}, {{@.schemaMatchCount(~/schemaMatches.views)}} match{{/if}}
      </div>
    </tab>
    <tab title=Functions>
      <virtual-list bind-items="functions" size=34 style="flex-grow: 1;">
        <header>
          <div style="border-bottom: 1px solid; margin-top: 0.25em;">
            <div class="schema-row fn" style="font-weight: bold;">
              <div class="name">Name</div>
              <div class="lang">Language</div>
              <div class="args">Arguments</div>
              <div class="result">Result</div>
            </div>
          </div>
        </header>
        <item class="striped-{{index % 2 ? 'odd' : 'even'}}">
          <div class="schema-row fn">
            <div class="name" title="{{.type}} {{.name}}({{.arguments}}): {{.result}}{{'\n--------\n'}}{{.source}}" on-click="copyToClipboard(@event.shiftKey ? `${.type} ${.name}(${.arguments}): ${.result}\n--------\n${.source}` : .source, `Copied ${.name} source to clipboard.`)">{{.name}}</div>
            <div class="lang" title="{{.language}}">{{.language}}</div>
            <div class="args" title="{{.arguments}}">{{.arguments}}</div>
            <div class="result" title="{{.result}}">{{.result}}</div>
          </div>
        </item>
        <else>
          <div class="schema-row">
            No funtions
          </div>
        </else>
      </virtual-list>
      <div style="padding: 0.5em; border-top: 1px solid;">
        {{_schema.functions.length}} functions
      </div>
    </tab>
  </tabs>
</script>

<script type=text/ractive id=schema-compare>
  <div class=content-wrapper>
    {{#each diff as pair}}
      {{#if pair[0] != null && pair[1] != null}}
        <div class="schema-diff striped">
          <div class="name" title="{{@key}}">{{@key}}</div>
          <div class="left" title="{{pair[0]}}">{{typeof pair[0] === 'object' ? JSON.stringify(pair[0]) : pair[0]}}</div>
          <div class="right" title="{{pair[1]}}">{{typeof pair[1] === 'object' ? JSON.stringify(pair[1]) : pair[1]}}</div>
        </div>
      {{else}}
        <div class="schema-diff whole striped">
          <div class="name">{{#if pair[0] == null}}Added{{else}}Removed{{/if}} {{@key}}</div>
          {{#each pair[0] || pair[1]}}
            <div class="entry"><div class="key">{{@key}}</div><div class="value">{{typeof . === 'object' ? JSON.stringify(.) : .}}</div></div>
          {{/each}}
        </div>
      {{/if}}
    {{else}}
      No differences.
    {{/each}}
  </div>
</script>

<script type=text/ractive id=scratch-pad>
  {{#partial header}}
    <div style="display: flex; flex-shrink: 0;">
      {{#if pad.syntax === 'raport'}}<label as-field class=inline><button class=flat on-click="@.evaluate(pad.text)" style="line-height: 2.5em; height: 2em;" title="Evaluate expression (ctrl+enter). Highlight a portion of text and shift+click or ctrl+enter to evaluate only the highlighted text."><span style="font-size: 1.5em;">&#9658;</span></button></label>{{/if}}
      <label as-field class=inline title="Separating segments of a file name with / will result in the pad appearing in a sub-node of the scratch pad tree view."><input value="{{pad.name}}" placeholder="Name..." lazy=1000 /></label>
      <div style="flex-grow: 1; display: flex; justify-content: space-around;">
        {{#if ~/pad._id}}
          {{#if ~/unsaved}}<div style="padding: 0.5em; opacity: 0.7; background-color: rgba(128, 128, 128, 0.5); border-radius: 0 0 0.5em 0.5em; height: 1em;">unsaved</div>{{/if}}
        {{else}}
          <button style="align-self: center;" on-click="@.save()">Save</button>
        {{/if}}
      </div>
      <label as-field class=inline><select value="{{pad.syntax}}" lazy=1000>
        <option value="{{undefined}}">plain text</option>
        <option>c_cpp</option>
        <option>csharp</option>
        <option>css</option>
        <option>ejs</option>
        <option>golang</option>
        <option>handlebars</option>
        <option>html</option>
        <option>ini</option>
        <option>java</option>
        <option>javascript</option>
        <option>json</option>
        <option>jsx</option>
        <option>julia</option>
        <option>kotlin</option>
        <option>less</option>
        <option>liquid</option>
        <option>lisp</option>
        <option>lua</option>
        <option>markdown</option>
        <option>mediawiki</option>
        <option>nix</option>
        <option>nunjucks</option>
        <option>ocaml</option>
        <option>odin</option>
        <option>pascal</option>
        <option>perl</option>
        <option>pgsql</option>
        <option>php</option>
        <option>plain_text</option>
        <option>python</option>
        <option>raport</option>
        <option>ruby</option>
        <option>rust</option>
        <option>sass</option>
        <option>scala</option>
        <option>scheme</option>
        <option>sh</option>
        <option>sql</option>
        <option>stylus</option>
        <option>svg</option>
        <option>swift</option>
        <option>tcl</option>
        <option>toml</option>
        <option>tsx</option>
        <option>twig</option>
        <option>typescript</option>
        <option>vue</option>
        <option>xml</option>
        <option>xquery</option>
        <option>yaml</option>
        <option>zig</option>
      </select></label>
    </div>
  {{/partial}}
  <div style="flex-grow: 1; position: relative; display: flex;">
    {{#if pad.syntax === 'raport'}}
      <split>
        <div style="height: 100%; display: flex; flex-direction: column;">
          {{>header}}
          <div style="flex-grow: 1;" class="editor-el" as-tracked=`ace` as-ace="{ bind: 'pad.text', syntax: pad.syntax || 'plain_text', theme: @style.theme == 'dark' ? (~/editor.darkTheme || 'tomorrow_night_eighties') : (~/editor.lightTheme || 'tomorrow'), wrap: ~/editor.wrap, highlightActive: ~/editor.highlightActive, fontSize: '1em', font: 'monospace', printMargin: ~/editor.printMargin, keymode: ~/editor.keymode, lineNumbers: ~/editor.lineNumbers, relativeLineNumbers: ~/editor.relativeLineNumbers, highlightSelected: ~/editor.highlightSelected, softTabs: ~/editor.softTabs, tabSize: ~/editor.tabSize }" on-save="@.save()" on-keydown="@event.ctrlKey && @event.key === 'Enter' ? @.evaluate(pad.text) : true" />
        </div>
        <tabs pad flex size=0 style="height: 100%;">
          <tab>
            <title>{{~/evalerror ? 'Error' : 'Result'}}</title>
            <pre><code on-click="copyToClipboard(~/evalresult)" title="click to copy result to the clipboard">{{~/evalerror || ~/evaltext}}</code></pre>
          </tab>
          <tab hidden="{{~/evalerror}}" title="Tree" no-pad>
            <div style="position: absolute; top: 0; right: 0; background-color: rgba(128, 128, 128, 0.2); border-radius: 0 0 0 1em;">
              <label as-field class=inline style="min-height: 2.7em;"><input type="checkbox" checked="{{~/expandAll}}" /> Expand all?</label>
            </div>
            {{>root ~/treeresult}}
          </tab>
          <tab title="Language Reference" right no-pad>
            <iframe style="border: none; flex-grow: 1; flex-shrink: 1; max-height: 100%;" srcdoc="{{~/docs.languageReference(100, @style.theme)}}" />
          </tab>
          <tab title="Operators" right no-pad>
            <div class="ops-search" style="display: flex; justify-content: space-between; background: transparent; position: absolute; top: 0; width: 100%;">
              <label as-field class=inline style="background-color: rgba(128, 128, 128, 0.2); border-radius: 0 0 1em 0; backdrop-filter: blur(5px);"><input lazy=500 placeholder="Search..." value="{{opDocSearch}}" style="width: 10em; margin: 0.5em;" title="Find any operators with docs containing the string entered here." /></label>
              <label as-field class=inline style="background-color: rgba(128, 128, 128, 0.2); border-radius: 0 0 0 1em; backdrop-filter: blur(5px);"><input lazy=500 placeholder="Operator..." value="{{opDoc}}" style="width: 10em; margin: 0.5em;" title="Find any operators with a name containing the string entered here." /></label>
            </div>
            <div style="padding: 0.5rem; height: 100%; width: 100%; overflow: auto; box-sizing: border-box;">
              <div style="max-width: 60em; margin: auto; color: {{@style.raui.primary.fg}};">
                <h2 style="text-align: center;">Raport Operators</h2>
                <dl>
                  {{#each operators as op}}{{#if (!~/opDoc || op.0.includes(~/opDoc)) && (!~/opDocSearch || JSON.stringify(op.1).toLowerCase().includes(~/opDocSearch.toLowerCase()))}}
                  <dt style="border-bottom: 1px dotted; margin-bottom: 0.25rem; margin-top: 2rem;"><h3>{{op.0.0 === '#' ? 'Format ' + op.0.slice(1) : op.0}}{{#if op.1.alias}} <em style="font-size: 0.8em;"> - (alias for <strong>{{op.1.alias}}</strong>)</em>{{/if}}</h3></dt>
                    <dd>
                      <dl>
                        {{#each op.1.sig}}
                          <dt>
                            <strong>{{.proto}}</strong>{{#if .bin}} <em>or</em> <strong>arg1 {{op.0}} arg2</strong>{{/if}}{{#if .un}} or <strong>{{op.0}}arg1</strong>{{/if}}
                            {{#if .agg}}<br /><em>arg1 can implicitly be <code>@source</code></em>{{/if}}
                          </dt>
                          <dd>{{.desc}}</dd>
                        {{/each}}
                      </dl>
                      {{#if op.1.opts.length}}
                        <h4>Options</h4>
                        <dl>
                          {{#each op.1.opts}}
                          <dt><strong>{{Array.isArray(.name) ? .name.join(' or ') : .name}}{{#if .type}} - <em>{{.type}}</em>{{/if}}</strong></dt>
                            <dd>{{.desc}}</dd>
                          {{/each}}
                        </dl>
                      {{/if}}
                    </dd>
                    {{/if}}{{/each}}
                </dl>
              </div>
            </div>
          </tab>
        </tabs>
      </split>
    {{elseif pad && 'text' in pad}}
      <div style="flex-grow: 1; display: flex; flex-direction: column;">
        {{>header}}
        <div style="flex-grow: 1;" class="editor-el" as-ace="{ bind: 'pad.text', syntax: pad.syntax || 'plain_text', theme: @style.theme == 'dark' ? (~/editor.darkTheme || 'tomorrow_night_eighties') : (~/editor.lightTheme || 'tomorrow'), wrap: ~/editor.wrap, highlightActive: ~/editor.highlightActive, fontSize: '1em', font: 'monospace', printMargin: ~/editor.printMargin, keymode: ~/editor.keymode, lineNumbers: ~/editor.lineNumbers, relativeLineNumbers: ~/editor.relativeLineNumbers, highlightSelected: ~/editor.highlightSelected, softTabs: ~/editor.softTabs, tabSize: ~/editor.tabSize }" on-save="@.save()" />
        </div>
    {{/if}}
  </div>
</script>

<script type=text/ractive id=host-explore>
  <div style="display: flex; height: 100%;">
    <div style="width: 22em; flex-shrink: 0; flex-grow: 0; border-right: 1px solid; padding: 0.5em; overflow: auto;">
      <div class=filter-pane style="position: sticky; top: -0.5em; border-bottom: 1px solid; padding: 0.5em; margin: -0.5em -0.5em 0.5em -0.5em; display: flex;" title="Filter visible databases using a raport expression. Visible databases will be condidates to query all, so collapsing a host node will prevent any databases on that node from being queried.{{'\n\n'}}Available fields are connection: { host, port, username, password, database, ssl, label }, entry: { access, collate, ctype, data, encoding, owner }, constr, db, index, query, last-query{{'\n\n'}}Any applied query results are also available here by their applied name as a property of query e.g. query.appliedname with the type { error: string } or { rows: any[], count: number }. If a query is run and not applied or saved as a result, it will be available as last-query.">
        <label as-field class=inline style="width: 100%;">
          <input value="{{~/filter}}" style="flex-grow: 1; padding: 0.25em;" lazy=1000 placeholder="Filter Expression" />
        </label>
      </div>
      {{#each ~/connections as con}}
        <div class="host" style="display: flex; position: sticky; top: 4.1em; word-break: break-all; align-items: center; justify-content: space-between; cursor: pointer;" on-click="Array.isArray(~/hosts[.constr]) && @event.shiftKey ? [appSet('scratchroot.sources.databases', { value: ~/hosts[.constr] }), @.host.toast('Database list is now available to raport scratch pads as *databases.', { type: 'info', timeout: 3000 })] : @.toggle('expanded.' + escapeKey(.constr))" title="Click to expand.{{#if Array.isArray(~/hosts[.constr])}} shift+click to make database list available to raport scratch pads as *databases.{{/if}}">
          <div style="width: 1em; height: 1em; display: flex; border: 1px solid; align-items: center; justify-content: center; margin-right: 0.5em; flex-shrink: 0; cursor: pointer;">
            {{#if ~/expanded[.constr]}}-{{else}}+{{/if}}
          </div>
          <div style="padding: 0.2em;">{{#if .label}}<strong>{{.label}}</strong> <em>({{.constr}})</em>{{else}}<em>{{.constr}}</em>{{/if}}{{#if ~/hosts && ~/expanded[.constr] && Array.isArray(~/hosts[.constr])}} ({{~/_entries[.constr].length}} / {{~/hosts[.constr].length}}){{/if}}</div>
          <div class="round fade" on-click="@event.shiftKey ? @.editHost(con) : @.refreshHost(con), false" title="Refresh host database list. shift+click to edit connection settings.">&#10227;</div>
        </div>
        <div style="padding-left: 1.5em;">
          {{#if ~/expanded[.constr]}}
            {{#if ~/hosts[.constr].error}}
              <div style="display: flex; padding: 0.2em; justify-content: space-between; color: darkred;"><span>{{~/hosts[.constr].error}}</span></div>
            {{elseif ~/hosts && Array.isArray(~/hosts[.constr])}}
              {{#each ~/_entries[.constr] as entry}}
                <div style="display: flex; padding: 0.2em; justify-content: space-between;" on-click="@.set('selectedDB', { connection: con, entry: entry })" class-selected="~/selectedDB.connection.constr === con.constr && ~/selectedDB.entry.database === .database"><span>{{.database}}</span></div>
              {{/each}}
            {{else}}
              <div style="padding: 0.5em;">[[@.refreshHost(.) && 'Loading...']]</div>
            {{/if}}
          {{/if}}
        </div>
      {{/each}}
      <div style="margin-top: 2em; display: flex; justify-content: space-around;">
        <button style="opacity: 0.7;" on-click="@.editHost()">Add Connection</button>
      </div>
    </div>
    <tabs pad style="overflow: hidden;" flex>
      <tab no-pad title="Database">
        {{#if ~/selectedDB}}
          {{#with ~/selectedDB}}
            <tabs defer style="overflow: hidden; margin-top: 2px; flex-grow: 1;" pad flex>
              <tab title="Info">
                <div style="padding: 0.5em;">
                  {{.entry.database}} on {{.connection.config.host}}:{{.connection.config.port}}
                  <table>
                    {{#each .entry}}
                      <tr><th>{{@key}}</th><td>{{.}}</td></tr>
                    {{/each}}
                  </table>
                </div>
              </tab>
              <tab title="Schema" on-enter="@.set('showSchema', true)" on-leave="@.set('showSchema', false)" no-pad>
                {{#if ~/showSchema}}
                  {{#if ~/schemas[.connection.constr + '@' + .entry.database]}}
                    {{#with Object.assign({}, .connection.config, { database: .entry.database }) as _config}}
                      {{#with ~/schemas[.connection.constr + '@' + .entry.database]}}
                        {{#if .error}}
                          <div style="padding: 0.5em;">Error loading schema...</div>
                        {{else}}
                          {{#with @.schemaEntries(.schema, 'tables') as tables, @.schemaEntries(.schema, 'views') as views, .schema.functions as functions, .schema as _schema}}
                            {{>schema-inner}}
                          {{/with}}
                        {{/if}}
                      {{/with}}
                    {{/with}}
                  {{else}}
                    <div style="padding: 0.5em;">[[@.refreshSchema(.) && 'Loading...']]</div>
                  {{/if}}
                {{/if}}
              </tab>
              <tab title="Query" no-pad>
                <div style="position: relative; height: 100%; flex-grow: 1; display: flex; flex-direction: column;">
                  {{>query}}
                </div>
              </tab>
              <tab title="Reports" no-pad>
                <div style="display: flex; height: 100%; margin-top: 2px;">
                  <div style="flex-grow: 1;">
                    {{#if ~/queryreport}}
                      <tabs style="overflow: hidden;" flex pad>
                        <tab title="Details">
                          <div style="display: flex; justify-content: space-between; align-items: center;"><span>{{~/queryreport.definition.name}}</span><button on-click="@.reportDesigner(~/queryreport)">Report Designer</button></div>
                          <h3>Queries</h3>
                          <dl>
                            {{#each ~/queryreport.sources}}
                              {{#if .type === 'query'}}
                                <dt>{{.name}}</dt><dd>{{.query}}</dd>
                              {{/if}}
                            {{/each}}
                          </dl>
                        </tab>
                        <tab title="Run">
                          <div>
                            {{#each ~/queryreport.definition.parameters}}
                              <label as-field>{{.label || .name}}<input value="{{~/params[.name]}}" /></label>
                            {{/each}}
                          </div>
                          <div>
                            <button on-click="@.runSingleReport(queryreport, false, ~/params, false)">View Report</button>
                            <button on-click="@.runSingleReport(queryreport, false, ~/params, true)">Download Report</button>
                          </div>
                        </tab>
                        <tab button right hidden="{{!~/queryreport}}" on-click="@.swapReport('queryreport')">
                          <title><span title="Close report">&times;</span></title>
                        </tab>
                      </tabs>
                    {{else}}
                      <div style="padding: 0.5em; opacity: 0.5;">
                        Select a report or <button on-click="@.reportDesigner()">Add Report</button>
                      </div>
                    {{/if}}
                  </div>
                  <div style="width: 15em; flex-shrink: 0; background-color: rgba(128, 128, 128, 0.05); border-left: 1px solid #222;">
                    {{#each ~/report.list}}
                      {{#if .query}}
                        <div style="padding: 0.5em;" on-click="@.swapReport('queryreport', .)" class-selected="~/queryreport._id === .id">{{.name}}</div>
                      {{/if}}
                    {{/each}}
                  </div>
                </div>
              </tab>
            </tabs>
          {{/with}}
        {{else}}
          <div style="padding: 0.5em;">Select a database</div>
        {{/if}}
      </tab>
      <tab title="Query All" no-pad>
        <tabs style="margin-top: 2px; overflow: hidden; height: 100%;" pad flex>
          <tab title="Reports" no-pad>
            <div style="display: flex; height: 100%; margin-top: 2px;">
              <div style="flex-grow: 1;">
                {{#if ~/allreport}}
                  <tabs style="overflow: hidden;" flex pad>
                    <tab title="Details">
                      <div style="display: flex; justify-content: space-between; align-items: center;"><span>{{~/allreport.definition.name}}</span><button on-click="@.reportDesigner(~/allreport)">Report Designer</button></div>
                      <h3>Queries</h3>
                      <dl>
                        {{#each ~/allreport.sources}}
                          {{#if .type === 'query-all-sql'}}
                            <dt>{{.name}}</dt><dd>{{.query}}</dd>
                          {{/if}}
                        {{/each}}
                      </dl>
                    </tab>
                    <tab title="Run">
                      <div style="padding: 0.3em; display: flex;"><div style="flex-shrink: 1;">Reports will run against all visible databases in the Host Explorer tree.</div><label style="width: 9em; flex-shrink: 0;" as-field>Concurrency <tip>The number of concurrent connections to utilize on the server. This is used for all requested databases, so up to this number could be used on a single target server or down to 1/x of this number where x is the number of servers with visible databases.</tip><input type=number placeholder=10 value="{{~/concurrency}}" /></label></div>
                      <div>
                        {{#each ~/allreport.definition.parameters}}
                          <label as-field>{{.label || .name}}<input value="{{~/params[.name]}}" /></label>
                        {{/each}}
                      </div>
                      <div>
                        <button on-click="@.runReport(allreport, false, false)" {{#unless @.visibleDBs().length}}disabled title="At least one database must be visible in the list of databases to run this report."{{/unless}}>View Report</button>
                        <button on-click="@.runReport(allreport, false, true)" {{#unless @.visibleDBs().length}}disabled title="At least one database must be visible in the list of databases to run this report."{{/unless}}>Download Report</button>
                      </div>
                    </tab>
                    <tab button right hidden="{{!~/allreport}}" on-click="@.swapReport('allreport')">
                      <title><span title="Close report">&times;</span></title>
                    </tab>
                  </tabs>
                {{else}}
                  <div style="padding: 0.5em; opacity: 0.5;">
                    Select a report or <button on-click="@.reportDesigner()">Add Report</button>
                  </div>
                {{/if}}
              </div>
              <div style="width: 15em; flex-shrink: 0; background-color: rgba(128, 128, 128, 0.05); border-left: 1px solid #222;">
                {{#each ~/report.list}}
                  {{#if .queryAll}}
                    <div style="padding: 0.5em;" on-click="@.swapReport('allreport', .)" class-selected="~/allreport._id === .id">{{.name}}</div>
                  {{/if}}
                {{/each}}
              </div>
            </div>
          </tab>
          <tab title="Query">
            <div style="display: flex; flex-direction: column; flex-grow: 1;">
              <div style="padding: 0.3em; display: flex;"><div style="flex-shrink: 1;">Queries will run against all visible databases in the Host Explorer tree. Queries run here are useful to extend data available for filtering. Results may be provided for reports, but having a report with a query all source is preferable.</div><label style="width: 9em; flex-shrink: 0;" as-field>Concurrency <tip>The number of concurrent connections to utilize on the server. This is used for all requested databases, so up to this number could be used on a single target server or down to 1/x of this number where x is the number of visible databases.</tip><input type=number placeholder=10 value="{{~/concurrency}}" /></label></div>
              <div style="flex-grow: 1; border: 1px solid rgba(128, 128, 128, 0.4); margin: 0.5em 0;" as-ace="{ bind: '~/queryall', syntax: 'pgsql', theme: @style.theme == 'dark' ? (~/editor.darkTheme || 'tomorrow_night_eighties') : (~/editor.lightTheme || 'tomorrow'), wrap: ~/editor.wrap, highlightActive: ~/editor.highlightActive, fontSize: '1em', font: 'monospace', printMargin: ~/editor.printMargin, keymode: ~/editor.keymode, lineNumbers: ~/editor.lineNumbers, relativeLineNumbers: ~/editor.relativeLineNumbers, highlightSelected: ~/editor.highlightSelected, softTabs: ~/editor.softTabs, tabSize: ~/editor.tabSize }" />
              <div>
                <label as-field title="Give a name to the result set to be available in the expression filter of this host explorer. Applied results are added to any existing results, so collapsing a host that already has results and rerunning a query will not remove the previous result. Applied results will also be available to any raport scratch pads as sources with their given names.">Apply As<input value="{{~/queryapply}}" /></label>
                <label as-field><button on-click="@.queryAll(~/queryall, ~/queryapply), @.set('queryapply', '')">Run</button></label>
                <label as-field style="margin-left: 2em;"><button class-reject title="Clear cached results. To clear all, leave Apply As blank. To clear a specific set, fill the desired name in Apply As." on-click="@.clearResult('applied', ~/queryapply)">Clear Results</button></label>
                <hr />
                <label as-field title="Provide a result set with the given name, which will be available to any reports that have a provided query all source of the same name. Provided sources will also be available to any raport scratch pads as sources with their given names.">Provide Result<input value="{{~/queryname}}" /></label>
                <label as-field><button on-click="@.queryAll(~/queryall, undefined, ~/queryname), @.set('queryname', '')">Run</button></label>
                <label as-field style="margin-left: 2em;"><button class-reject title="Clear cached provided results. To clear all, leave Provided Result blank. To clear a specific set, fill the desired name in Provided Result." on-click="@.clearResult('provided', ~/queryname)">Clear Results</button></label>
              </div>
            </div>
          </tab>
        </tabs>
      </tab>
    </tabs>
  </div>
</script>

<script type=text/ractive id=report>
  <iframe src="./report.html"></iframe>
  {{#unless ~/control.topmost}}<div style="position: absolute; top: 0; left: 0; right: 0; bottom: 0;" />{{/unless}}
  <buttons>
    <button left on-click="@.close()">Cancel</button>
    <button on-click="@.save()">Save</button>
  </buttons>
</script>

<script type=text/ractive id=view-report>
  <iframe srcdoc="{{html}}" />
</script>

<script type=text/ractive id=source-edit>
  <div class=content-wrapper>
    <div>
      <label as-field as-autofocus>Name<input value="{{source.name}}" /></label>
      <label as-field>Type<select value="{{source.type}}" on-change="@node.value === 'diff' ? @.set('source', { type: 'diff'}) : true">
        <option value="diff">Diff Entries</option>
        <option value="diff-schema">Diff Schema</option>
        {{#if !@global.clientOnly}}
          <option value="query">Query</option>
          <option value="query-all">Query All Provided Result</option>
          <option value="query-all-sql">Query All</option>
        {{/if}}
        <option value="json">JSON</option>
      </select></label>
      {{#if source.type === 'query'}}<label as-field><input type=checkbox checked="{{source.config !== undefined}}" twoway=false on-change="@.set('source.config', @node.checked ? {} : undefined)" /> Custom connection?</label>{{/if}}
    </div>
    {{#if source.type === 'query'}}
      {{#if !!source.config}}
        <div>
          <label as-field>Host<input value="{{source.config.host}}" /></label>
          <label as-field>Port<input type=number value="{{source.config.port}}" /></label>
          <label as-field>SSL<select value="{{source.config.ssl}}">
            <option value="{{undefined}}">Default</option>
            <option value="prefer">Prefer</option>
            <option value="require">Require</option>
            <option value="{{false}}">None</option>
          </select></label>
          <label as-field>User<input value="{{source.config.username}}" /></label>
          <label as-field>Password<input type=password value="{{source.config.password}}" /></label>
          <label as-field>Database<input value="{{source.config.database}}" /></label>
        </div>
      {{/if}}
      <div style="flex-grow: 1; border: 1px solid rgba(128, 128, 128, 0.4); margin: 0.5em 0; min-height: 15em;" as-ace="{ bind: 'source.query', syntax: 'pgsql', theme: @style.theme == 'dark' ? (~/editor.darkTheme || 'tomorrow_night_eighties') : (~/editor.lightTheme || 'tomorrow'), wrap: ~/editor.wrap, highlightActive: ~/editor.highlightActive, fontSize: '1em', font: 'monospace', printMargin: ~/editor.printMargin, keymode: ~/editor.keymode, lineNumbers: ~/editor.lineNumbers, relativeLineNumbers: ~/editor.relativeLineNumbers, highlightSelected: ~/editor.highlightSelected, softTabs: ~/editor.softTabs, tabSize: ~/editor.tabSize }" />
      {{#if ~/error}}<div style="color: red;">{{~/error}}</div>{{/if}}
      <div>
        {{#each ~/paramArray}}
          <label as-field>Parameter ${{@index + 1}}<input value="{{source.parameters[@index]}}" /></label>
        {{/each}}
      </div>
    {{elseif source.type === 'json'}}
      <label as-field>JSON<textarea>{{source.json}}</textarea></label>
    {{elseif source.type === 'query-all'}}
      <label as-field>Result Name<input value="{{source.result}}" /></label>
    {{elseif source.type === 'query-all-sql'}}
      <div style="flex-grow: 1; border: 1px solid rgba(128, 128, 128, 0.4); margin: 0.5em 0; min-height: 15em;" as-ace="{ bind: 'source.query', syntax: 'pgsql', theme: @style.theme == 'dark' ? (~/editor.darkTheme || 'tomorrow_night_eighties') : (~/editor.lightTheme || 'tomorrow'), wrap: ~/editor.wrap, highlightActive: ~/editor.highlightActive, fontSize: '1em', font: 'monospace', printMargin: ~/editor.printMargin, keymode: ~/editor.keymode, lineNumbers: ~/editor.lineNumbers, relativeLineNumbers: ~/editor.relativeLineNumbers, highlightSelected: ~/editor.highlightSelected, softTabs: ~/editor.softTabs, tabSize: ~/editor.tabSize }" />
      {{#if ~/error}}<div style="color: red;">{{~/error}}</div>{{/if}}
      <div>
        {{#each ~/paramArray}}
          <label as-field>Parameter ${{@index + 1}}<input value="{{source.parameters[@index]}}" /></label>
        {{/each}}
      </div>
    {{/if}}
  </div>
  <buttons>
    <button left on-click="@.close()">Cancel</button>
    <button on-click="@.save()" disabled="{{!!error}}">Done</button>
  </buttons>
</script>

<script type=text/ractive id=connect>
  <div class="connect">
    <label as-field as-autofocus>Host<input value="{{~/config.host}}" /></label>
    <label as-field>Port<input type=number value="{{~/config.port}}" /></label>
    <label as-field>User<input value="{{~/config.username}}" /></label>
    <label as-field>Password<input type=password value="{{~/config.password}}" /></label>
    <label as-field>Database<input value="{{~/config.database}}" /></label>
    <label as-field>SSL<select value="{{~/config.ssl}}">
      <option value="{{undefined}}">Default</option>
      <option value="prefer">Prefer</option>
      <option value="require">Require</option>
      <option value="{{false}}">None</option>
    </select></label>
    <label as-field>Label<input value="{{~/config.label}}" /></label>
    <label as-field>Use<select value="{{~/config.use}}">
      <option value="{{undefined}}">All</option>
      <option value="diff">Diff</option>
      <option value="host">Host Explorer</option>
    </select></label>
    {{#if !~/config.use || ~/config.use === 'diff'}}
      <fieldset style="margin: 1em 0.5em;">
        <legend>Diff Options</legend>
        <label as-field>Max Length <tip>The maximum allowable length of any value of any column to be recorded directly in a diff. Any values with lengths that exceed this number will instead be checksummed. This will affect your ability to undo diffs, as the checksummed value may not be valid in the source column. This defaults to 0, which disables the feature.</tip><input type=number value="{{~/config.diffopts.maxlen}}" placeholder="0" /></label>
        <label as-field>Change Records<select value="{{~/config.diffopts.changes}}">
          <option value="{{undefined}}">Record only changed fields and keys if possible.</option>
          <option value="whole">Always record the full old and new records.</option>
          <option value="whole-old">Always record the full old record and only changed fields and keys in the new record if possible.</option>
        </select></label>
        <field tip="This can be a table name, a schema.table name, or an ilike pattern that matches either table or schema.table. '__pgdifficult_%' and 'pgdifficult.%' are automatically ignored." label="Ignore Patterns" value="{{~/ignore}}"><button on-click="@.push('config.diffopts.ignore', ~/ignore), @.set('ignore', '')">Add</button></field>
        <h3 style="border-bottom: 1px solid; margin: 1em 0 0.5em 0;">Ignored Pattern List</h3>
        {{#each ~/config.diffopts.ignore}}
          <div class="wrapper striped-{{@index % 2 == 0 ? 'even' : 'odd'}}" style="display: flex;">
            <label as-field class=inline style="flex-grow: 1;"><input value="{{.}}" /></label>
            <label as-field class=inline style="flex-shrink: 0;"><button on-click="@.splice('~/config.diffopts.ignore', @index, 1)">Remove</button></label>
          </div>
        {{else}}
          <em>No ignored patterns</em>
        {{/each}}
      </fieldset>
    {{/if}}
  </div>
  <buttons>
    <button left class=flat on-click="@.cancel()">Cancel</button>
    <button on-click="@.accept()">Done</button>
  </buttons>
</script>

<script type=text/ractive id=diff>
  <div class=differ style="display: flex; width: 100%; height: 100%;">
    <split vertical>
      <div size=33 style="display: flex; flex-direction: column; position: relative; height: 100%;">
        <div style="display: flex; justify-content: space-evenly; align-items: center;">
          <h3>Left</h3>
          <select value="{{leftView}}"><option value="{{undefined}}">text</option><option>tree</option></select>
        </div>
        {{#if ~/copied.recent}}
          <div class=paster on-click="@.paste('left', @event.shiftKey)"><span>click to paste<br/>shift+click to apply patch</span></div>
        {{elseif leftView === 'tree'}}
          {{>root .lefttree}}
        {{else}}
          <textarea style="flex-grow: 1; resize: none;" placeholder="Left value here..." lazy=1000>{{.left}}</textarea>
        {{/if}}
      </div>
      <div size=34 style="position: relative; padding: 0.2rem; display: flex; flex-direction: column; height: 100%; box-sizing: border-box;">
        <div style="display: flex; justify-content: space-evenly; align-items: center;">
          {{#if ~/leftView === 'tree' || ~/rightView === 'tree'}}<label style="font-size: 0.7em;"><input type=checkbox checked="{{~/expandAll}}"> Expand all tree nodes?</label>{{/if}}
          <h3>Diff</h3>
          <div>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</div>
        </div>
        <pre style="overflow: auto;"><code>
        {{#each @.diff(.left, .right)}}
          <div style="display: flex; flex-wrap: wrap;">
            <div style="width: 100%; margin-top: 0.5rem; border-bottom: 1px solid #999; padding: 0.2rem; font-weight: 600;">{{@key}}</div>
            <div style="width: 50%; padding: 0.5rem; box-sizing: border-box;">{{@.string(this.0)}}</div>
            <div style="width: 50%; padding: 0.5rem; box-sizing: border-box; border-left: 1px dotted #aaa;">{{{@.string(this.1, this.0)}}}</div>
          </div>
        {{/each}}
        </code></pre>
      </div>
      <div size=33 style="display: flex; flex-direction: column; position: relative; height: 100%;">
        <div style="display: flex; justify-content: space-evenly; align-items: center;">
          {{#if ~/hasCSV}}<label style="font-size: 0.7em;"><input type=checkbox checked="{{~/csvHeader}}"> CSV Header?</label>{{/if}}
          <h3>Right</h3>
          <select value="{{rightView}}"><option value="{{undefined}}">text</option><option>tree</option></select>
        </div>
        {{#if ~/copied.recent}}
          <div class=paster on-click="@.paste('right', @event.shiftKey)"><span>click to paste<br/>shift+click to apply patch</span></div>
        {{elseif rightView === 'tree'}}
          {{>root .righttree}}
        {{else}}
          <textarea style="flex-grow: 1; resize: none;" placeholder="Right value here..." lazy=1000>{{.right}}</textarea>
        {{/if}}
      </div>
    </split>
  </div>

  {{#partial root}}
    <div class=tree-view style="padding: 0.5em 0;">
      <div class=root>
        <div class=node>
          {{>.type}}
        </div>
      </div>
    </div>
  {{/partial}}
  {{#partial leaf}}<div class=value>{{.value}}</div>{{/partial}}
  {{#partial array}}
      <div class=type style="margin-left: 0.5em;">[</div>
      <div class=expand {{#if .children.length}}class-show on-click="@context.toggle('.expand')"{{/if}}>{{#if .expand}}-{{else}}+{{/if}}</div>
      {{#if .expand || ~/expandAll}}
        <div class=tree>
        {{#each .children}}
          <div class=node><span class=key>{{.index}}</span><span style="color: #aaa; margin-left: 0.5em;">:</span>{{>.value.type .value}}</div>
        {{/each}}
        </div>
        <div class=type style="margin-left: 0.5em;">]</div>
      {{else}}
        <div class=type>]</div>
      {{/if}}
  {{/partial}}
  {{#partial node}}
      <div class=type style="margin-left: 0.5em;">{</div>
      <div class=expand {{#if .children.length}}class-show on-click="@context.toggle('.expand')"{{/if}}>{{#if .expand}}-{{else}}+{{/if}}</div>
      {{#if .expand || ~/expandAll}}
        <div class=tree>
        {{#each .children}}
          <div class=node><span class=key>{{.key}}</span><span style="color: #aaa; margin-left: 0.5em;">:</span>{{>.value.type .value}}</div>
        {{/each}}
        </div>
        <div class=type style="margin-left: 0.5em;">}</div>
      {{else}}
        <div class=type>}</div>
      {{/if}}
  {{/partial}}
</script>

<script type=text/ractive id=confirm>
  <div class=content-wrapper>
    <div class="message" style="max-width: 36em;"><pre style="font-family: sans-serif;">{{{.message}}}</pre></div>
  </div>
  <buttons>
    <button center on-click="@.close(false, true)">Yes</button>
    <button center class=reject on-click="@.close(false, false)">No</button>
  </buttons>
</script>

<script type=text/ractive id=ask>
  <div class=content-wrapper>
    <div class="message" style="max-width: 36em;">{{.message}}</div>
    <label as-field class=inline><input as-autofocus value="{{.value}}" on-keydown="@event.key === 'Escape' ? @.close() : @event.key === 'Enter' ? @.close(true, ~/value) : true" /></label>
  </div>
  <buttons>
    <button left class=flat on-click="@.close()">Cancel</button>
    <button on-click="@.close(true, ~/value)">Done</button>
  </buttons>
</script>

<script type=text/ractive id=choose>
  <div class=content-wrapper>
    <div class="message" style="max-width: 36em;">{{.message}}</div>
  </div>
</script>

  </head>
  <body>
<div id=target />

<script src="./index.js"></script>
<script src="./ace@1.35.4/ace.js"></script>
<script>
  Ractive.use(RauiAceEditor.default({ name: 'ace' }));
  ace.config.loadModule('ace/keybinding/vim', () => {
    const vim = ace.require('ace/keyboard/vim').Vim;
    // tweak the vim mappings
    vim.map('j', 'gj', 'normal');
    vim.map('k', 'gk', 'normal');
    vim.map('jk', '<Esc>', 'insert');
    vim.map('kj', '<Esc>', 'insert');
    vim.defineEx('write', 'w', cm => cm.ace.execCommand('save'));
  });
</script>
  </body>
</html>
