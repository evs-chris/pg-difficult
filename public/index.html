<!DOCTYPE html>
<html lang="en-US">
  <head>
    <title>pg-difficult</title>
    <link rel="shortcut icon" href="./icon.png" />
    <script src="./ractive@1.4.2.js"></script>
    <script src="./raport@0.24.8.js"></script>
    <script src="./raui@0.15.6/ace-editor.js"></script>
    <script src="./raui@0.15.6/button.js"></script>
    <script src="./raui@0.15.6/form.js"></script>
    <script src="./raui@0.15.6/Window.js"></script>
    <script src="./raui@0.15.6/AppBar.js"></script>
    <script src="./raui@0.15.6/Shell.js"></script>
    <script src="./raui@0.15.6/Split.js"></script>
    <script src="./raui@0.15.6/Menu.js"></script>
    <script src="./raui@0.15.6/Popover.js"></script>
    <script src="./raui@0.15.6/Tabs.js"></script>
    <script src="./raui@0.15.6/Table.js"></script>
    <script src="./raui@0.15.6/VirtualList.js"></script>
<style>
  html, body {
    margin: 0;
    padding: 0;
    font-family: sans-serif;
    width: 100%;
    height: 100%;
    box-sizing: border-box;
  }
  #target {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    box-sizing: border-box;
  }
  h1, h2, h3 {
    margin: 0;
    padding: 0 0 0.5em 0;
  }
  fieldset {
    border-color: rgba(128, 128, 128, 0.4);
    border-radius: 0.5em;
  }
  code.expr {
    display: inline-block;
    border: 1px solid rgba(0, 0, 0, 0.2);
    line-height: 1.4em;
    padding: 0.1em;
    vertical-align: text-bottom;
  }
  .content {
    display: flex;
  }
  .hamburger {
    width: 2em;
    height: 2em;
    cursor: pointer;
  }
  .hamburger:after {
    width: 100%;
    height: 100%;
    font-weight: bold;
    font-size: 1.5em;
    content: '\002261';
  }
  #not-connected {
    position: absolute;
    background-color: rgba(0, 0, 0, 0.2);
    width: 100%;
    height: 100%;
    top: 0;
    left: 0;
    position: absolute;
    display: flex;
    align-items: center;
    justify-content: space-around;
    z-index: 100;
    cursor: wait;
  }
  #not-connected .wrapper {
    display: flex;
    flex-direction: column;
  }
  .loader {
    width: 100%;
    height: 100%;
    transform: rotate(-90deg);
    stroke-linecap: round;
    stroke-width: 4;
    fill: none;
    display: block;
    margin: 0 auto;
  }
  .rappbar .loader {
    stroke-width: 10;
  }
  #not-connected .reconnecting {
    margin-top: 1em;
    text-align: center;
    font-weight: bold;
    color: #fff;
    font-size: 1.2rem;
    text-shadow: 0 0 1em #222;
  }
    
  .loader .internal-circle,
  .loader .external-circle {
    stroke: #fff;
    stroke-dashoffset: 0;
    transform-origin: center;
  }
  
  .loader .internal-circle {
    stroke-dasharray: 187;
    animation: internal-circle 1s ease-in-out infinite;
    opacity: .4;
  }
  
  .loader .external-circle {
    stroke-dasharray: 312;
    animation: external-circle 1s linear infinite;
    opacity: .9;
  }

  @keyframes internal-circle {
    0% {
      stroke-dashoffset: 187;
    }
    25% {
      stroke-dashoffset: 80;
    }
    100% {
      stroke-dashoffset: 187;
      transform: rotate(360deg);
    }
  }

  @keyframes external-circle {
    0% {
      stroke-dashoffset: 312;
      transform: rotate(70deg);
    }
    60% {
      stroke-dashoffset: -312;
    }
    100% {
      stroke-dashoffset: -312;
      transform: rotate(450deg);
    }
  }

  .stretch-fields {
    display: flex;
  }
  .stretch-fields > * {
    flex-grow: 1;
  }

  .striped:nth-child(odd), .striped-odd {
    background-color: rgba(128, 128, 128, 0.02);
    padding: 0.3em;
    box-sizing: border-box;
    border-radius: 0.3em;
  }
  .striped, .striped-even {
    background-color: rgba(128, 128, 128, 0.1);
    padding: 0.3em;
    box-sizing: border-box;
    border-radius: 0.3em;
  }
  .striped > * {
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .content-wrapper {
    display: flex;
    flex-direction: column;
    flex-grow: 1;
    overflow: auto;
    position: relative;
    padding: 0.5em;
    box-sizing: border-box;
  }

  .version { opacity: 0.5; }

  .field.error {
    color: red !important;
  }

  button.reject {
    color: #fff;
    background-color: #ca3c3c;
  }

  .schema { overflow: auto; }
  .schema-row { padding: 0.2em; position: relative; display: flex; flex-wrap: no-wrap; }
  .table { cursor: pointer; position: sticky; top: 0; z-index: 10; }
  .column .name { padding-left: 1.7em; box-sizing: border-box; }
  .schema-row > * { overflow: hidden; white-space: nowrap; text-overflow: ellipsis; }
  .schema-row .name { width: 55%; }
  .schema-row.table { display: flex; }
  .schema-row.table .name { width: auto; flex-grow: 1; }
  .schema-row.table .details { opacity: 0.5; }
  .schema-row.fn { display: flex; }
  .schema-row.fn .name { width: 20%; cursor: pointer; }
  .schema-row.fn .lang { width: 11%; }
  .schema-row.fn .args { width: 47%; }
  .schema-row.fn .result { width: 22%; }
  .schema-row .name.pkey { font-weight: bold; }
  .schema-row .type { width: 20%; }
  .schema-row .nullable { width: 7%; text-align: center; }
  .schema-row .default { width: 8%; text-align: center; }
  .schema-row .size { width: 10%; }

  .round {
    color: #eee;
    background-color: #444;
    flex-shrink: 0;
    flex-grow: 0;
    height: 1.4em;
    width: 1.4em;
    border-radius: 1.4em;
    flex-shrink: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    line-height: 1em;
    cursor: pointer;
  }

  .fade {
    opacity: 0.5;
    transition: opacity 0.2s ease-in-out;
  }
  .fade:hover {
    opacity: 1;
  }

  th {
    text-align: right;
  }

  .disconnected {
    display: inline-block;
    background-color: #a33;
    color: #fff;
    width: 1em;
    height: 1em;
    border-radius: 1em;
    user-select: none;
    cursor: help;
    text-align: center;
    margin: 0 0.5em;
  }
</style>
<!-- HEAD -->
<script type=text/ractive id=template>
  {{#if !~/halted || ~/connected}}
    <shell on-init="@.set('@.shell', $1)">
      <right hidden="{{menu.hidden}}" forced="{{menu.forced}}">
        <menu>
          <container>
            <div style="display: flex; align-items: center; justify-content: space-around; height: 3.6em; background-color: #325932;">
              <span><a style="color: #eee; text-decoration: none;" href="https://github.com/evs-chris/pg-difficult" target=_blank>pg-difficult</a> <span class=version>- v{{~/status.VERSION || '-client-only'}}</span></span>
            </div>
          </container>
          <item title="Control Panel" on-action="@.host.getWindow('control-panel').raise(true)" />
          <section title="Active Diffs" bind-items="~/diffs" bind-hidden="@global.clientOnly || (~/diffs || []).length < 1" />
          <section title="Monitored Connections" bind-items="~/leaks" bind-hidden="@global.clientOnly || (~/leaks || []).length < 1" />
          <section title="Queries" bind-items="~/queries" bind-hidden="@global.clientOnly || (~/queries || []).length < 1" />
          <section title="Tools" style="margin-top: 1em;">
            <item title="Reload Saved Entries" on-action="@.loadEntries()" />
            <item title="Reload Saved Schema" on-action="@.loadSchema()" />
          </section>
          <section title="Other Windows" style="margin-top: 1em;" bind-items="~/others" bind-hidden="(~/others || []).length < 1" />
        </menu>
      </right>
      <center style="display: flex; flex-direction: column;">
        {{#if !@.host.data.currentMax}}
          <app-bar>
            <left>
              <div style="height: 1.5em; font-size: 1.5em; cursor: pointer; user-select: none; margin-right: 1em;" title="Auto arrange windows" on-click="@.host.placeAll()">&#9638;</div>
              {{#if waiting}}<div style="height: 1.5em;">{{>loader}}</div>{{/if}}
            </left>
            <right><div class=hamburger title="Toggle menu" on-click="@.toggle('menu.hidden')" /></right>
          </app-bar>
        {{/if}}
        <div style="flex-grow: 1;">
          <host placement=smart on-init="@.set('@.host', $1)">
            <max-top>
              <app-bar>
                <left>{{#if waiting}}<div style="height: 1.5em;">{{>loader}}</div>{{/if}}</left>
                <center>{{window.title}}</center>
                <right>{{>windowControls}}<div class=hamburger title="Toggle menu" on-click="@.toggle('menu.hidden')" style="margin-left: 2em;" /></right>
              </app-bar>
            </max-top>
          </host>
        </div>
      </center>
    </shell>
    {{#unless ~/connected}}<div id="not-connected">
      <div class=wrapper>
        {{>loader}}
        <div class=reconnecting>Reconnecting...</div>
      </div>
    </div>{{/unless}}
    <input type=file id=file />
  {{else}}
    <div class=html style="width: 100vw; height: 100vh; display: flex; align-items: center; justify-content: center;">
      <h2 style="text-align: center;">
        pg-difficult stopped.<br />
        Please close this window/tab.
      </h2>
    </div>
  {{/if}}
</script>

<script type=text/ractive id=loader>
  <svg class="loader" viewBox="0 0 120 120" xmlns="http://www.w3.org/2000/svg">
    <circle class="internal-circle" cx="60" cy="60" r="30"></circle>
    <circle class="external-circle" cx="60" cy="60" r="50"></circle>
  </svg>
</script>

<script type=text/ractive id=control-panel>
  <tabs pad style="overflow: hidden; height: 100%;">
    <tab title="Connections" hidden="@global.clientOnly">
      <div style="display: flex; align-items: center; justify-content: space-between; padding: 0.3em;">
        <div>Connections are saved in browser storage and can be used to start diffs and run queries.<br/><br/><span style="color: #ca3c3c; font-weight: bold;">WARNING:</span> Starting a diff on a database will create a pgdifficult schema with two tables and a function, and then it will set the function as a trigger for each existing table in the database. A running diff in a database <em>will</em> cause performance degradation, especially if left to collect thousands of changes. You can exclude tables and set maximum captured value size in the connection settings.</div>
        <button style="flex-shrink: 0;" on-click="@.editConnection()" title="Add a saved connection for this browser at this url.">Add Connection</button>
      </div>
      <div style="overflow: auto;">
        {{#each connections}}
          <div class="connection striped">
            <div class="constr">
              <div style="flex-grow: 1;">{{#if .label}}<strong>{{.label}}</strong> ({{constr(.)}}){{else}}{{constr(.)}}{{/if}}<tip>{{`Maximium value length: ${.diffopts.maxlen || 'none'}\nChanged record capture: ${.diffopts.change === 'whole' ? 'both whole records' : .diffopts.change === 'whole-old' ? 'whole old record, new changes' : 'changes only'}\nIgnored tables: ${.diffopts.ignore.length ? .diffopts.ignore.join(', ') : 'none'}`}}</tip></div>
              <div style="width: 9em; flex-shrink: 0;">
                <button class=flat disabled="{{@index === 0}}" on-click="moveUp(@context, @event.shiftKey || @event.ctrlKey)" title="Move up, hold shift or ctrl to move to top">&#9650;</button>
                <button class=flat disabled="{{@index === @last}}" on-click="moveDown(@context, @event.shiftKey || @event.ctrlKey)" title="Move down, hold shift or ctrl to move to bottom">&#9660;</button>
              </div>
              <div style="width: 13em; flex-shrink: 0;">
                <button class=flat on-click="@.editConnection(@index)" {{#if @.hasDiff(.) || @.hasLeak(.)}}disabled title="Stop active watchers to modify this connection"{{else}}title="Edit this saved connection."{{/if}}>Edit</button>
                <button class=flat on-click="@.splice('connections', @index, 1)" {{#if @.hasDiff(.) || @.hasLeak(.)}}disabled title="Stop active watchers to modify this connection"{{else}}title="Remove this saved connection."{{/if}}>Remove</button><br/>
              </div>
            </div>
            <div class="actions">
              {{#if !@.hasDiff(.)}}<button on-click="@.startDiff(.)" disabled="{{@.diffWait(.)}}" title="Begin recording changes to tables in this database.">Start Diff</button>
              {{else}}
                <div>
                  <button on-click="@.stopDiff(.)" disabled="{{@.diffWait(.)}}" title="Cease recording changes to tables in this database.">Stop Diff</button>
                  <button on-click="@.entries(.)" title="View recoded entries from this database">Entries</button>
                </div>
              {{/if}}
              {{#if !@.hasLeak(.)}}<button on-click="@.startLeak(.)" title="Begin monitoring connections to this database.">Start Monitor</button>
              {{else}}
                <div>
                  <button on-click="@.stopLeak(.)" title="Cease monitoring connections to this database.">Stop Monitor</button>
                  <button on-click="@.leaks(.)" title="View monitored connecstions to this database">Connections</button>
                </div>
              {{/if}}
              <button on-click="@.query(.)" title="Open a query window to run queries against this database.">Query</button>
              <button on-click="@.schema(.)" title="View this database's schema.">Schema</button>
            </div>
          </div>
        {{else}}
          No connections have been saved.
        {{/each}}
      </div>
    </tab>
    <tab title="Active Diffs" hidden="@global.clientOnly">
      <div style="display: flex; justify-content: space-between; align-items: center;">
        <div style="flex-grow: 1; display: flex;">
          <label as-field style="flex-grow: 1;" title="The segment name groups sets of changes together. The segment will automatically be updated when you stop typing, and any new changes will get the new segment name.">Segment<input value="{{~/newSegment}}" lazy=1500 /></label>
        </div>
        <div>
          <button on-click="@.clear()" title="Remove all recorded changes.">Clear Entries</button>
          <button on-click="@.entries()" title="View all recorded entries in a single combined set.">Combined Entries</button>
          <button on-click="@.addDiff()" title="Start recording changes to an ephemeral connection.">Add Connection</button>
        </div>
      </div>
      <div style="overflow: auto;">
        {{#each Object.values(~/status.clients || {})}}
          <div class="record striped">
            <div class="constr">{{.source}}</div>
            <div class="actions">
              <button on-click="@.query(.config)" title="Open a query widnow to run queries against this database.">Query</button>
              <button on-click="@.schema(.config)" title="View this database's schema.">Schema</button>
              <button on-click="@.entries(.id)" title="View recorded entries from this database.">Entries</button>
              <button on-click="@.stopDiff(.config)" title="Cease recording changes to tables in this database.">Stop Diff</button>
            </div>
          </div>
        {{else}}
          There are no active diffs.
        {{/each}}
      </div>
    </tab>
    <tab title="Connection Monitor" hidden="@global.clientOnly">
      <div style="display: flex; justify-content: space-between; align-items: center;">
        <label as-field>Polling Interval<input type=number value="{{~/status.pollingInterval}}" on-change="@.poll()" lazy></label>
        <div style="flex-grow: 1;">
          The connection monitor polls the server for active connections at a set interval. Connections that appear after the initial connection is made are monitored.
        </div>
        <div style="text-align: right;">
          <button on-click="@.leaks()" title="View monitored connections for all databases.">All Connections</button>
          <button on-click="@.addLeak()" title="Start monitoring connections on an ephemeral connection.">Add Connection</button>
        </div>
      </div>
      <div style="overflow: auto;">
        {{#each Object.values(~/status.leaks || {})}}
          {{#each .databases}}
            <div class="record striped">
              <div class="constr">{{constr(^^/config, { database: . })}}</div>
              <div class=actions>
                <button on-click="@.query(^^/config, .)" title="Open a query widnow to run queries against this database.">Query</button>
                <button on-click="@.leaks(^^/id, .)" title="View monitored connections to this database.">Connections</button>
                <button on-click="@.schema(^^/config, .)" title="View this database's schema.">Schema</button>
                <button on-click="@.stopLeak(^^/config, .)">Stop Monitor</button>
              </div>
            </div>
          {{/each}}
        {{else}}
          There are no active connection monitors.
        {{/each}}
      </div>
    </tab>
    <tab title="Saved Queries" hidden="@global.clientOnly">
      <div style="padding: 0.3em;">Queries are saved in browser storage.</div>
      <div style="overflow: auto;">
        {{#each savedQueries}}
          <div class="query striped">
            <div class="name">{{.name}}</div>
            <div class="sql">{{.sql}}</div>
            <div class="actions">
              <button class=flat disabled="{{@index === 0}}" on-click="moveUp(@context, @event.shiftKey || @event.ctrlKey)" title="Move up, hold shift or ctrl to move to top">&#9650;</button>
              <button class=flat disabled="{{@index === @last}}" on-click="moveDown(@context, @event.shiftKey || @event.ctrlKey)" title="Move down, hold shift or ctrl to move to bottom">&#9660;</button>
              {{#if ~/loadedQuery === .}}
                <button on-click="@.set('loadedQuery', undefined)" title="Click to cancel waiting to load this query from a query window.">Cancel</button>
              {{else}}
                <button on-click="@.set('loadedQuery', .)" title="Set this query up to be loaded from a query window.">Load</button>
              {{/if}}
              <button on-click="@.splice('savedQueries', @index, 1)" title="Remove this query from browser storage.">Remove</button>
            </div>
          </div>
        {{else}}
          No queries have been saved.
        {{/each}}
      </div>
    </tab>
    <tab title="Reports">
      <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.3em;">
        <div style="padding: 0.3em;">Reports can be set up to run against a Diff, a Schema, a Provided Result from querying multiple database, a Query for multiple database, a Query for a single database, or a JSON blob. Query-based reports can be managed from the Host Explorer.</div>
        <div style="flex-shrink: 0;"><button title="Open a new report designer." on-click="@.report()">New Designer</button></div>
      </div>
      <div style="overflow: auto;">
        {{#each savedReports}}
          <div class="report striped">
            <div class=name>{{.definition.name}}</div>
            <div class=actions>
              <button class=flat disabled="{{@index === 0}}" on-click="moveUp(@context, @event.shiftKey || @event.ctrlKey)" title="Move up, hold shift or ctrl to move to top">&#9650;</button>
              <button class=flat disabled="{{@index === @last}}" on-click="moveDown(@context, @event.shiftKey || @event.ctrlKey)" title="Move down, hold shift or ctrl to move to bottom">&#9660;</button>
              <button on-click="@.report(.)" {{#if @.reportHasQuerySql(.)}}disabled title="This report uses SQL queries and must be accessed from the Host Explorer"{{else}}title="Open this report in the designer."{{/if}}>Designer</button>
              <button on-click="@.splice('savedReports', @index, 1)" title="Remove this report from browser storage.">Remove</button>
            </div>
          </div>
        {{else}}
          No reports have been saved.
        {{/each}}
      </div>
    </tab>
    <tab title="Scratch Pads">
      <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.3em;">
        <div style="padding: 0.3em;">Scratch pads are a place to write bits of text that are automatically saved to browser local storage when they are edited.</div>
        <div style="flex-shrink: 0;"><button title="Open a new scratch pad." on-click="@.scratch()">New Scratch Pad</button></div>
      </div>
      <div style="overflow: auto;">
        {{#each scratchPads}}
          <div class="scratch striped">
            <div class=name>{{.name}}</div>
            <div class=actions>
              <button class=flat disabled="{{@index === 0}}" on-click="moveUp(@context, @event.shiftKey || @event.ctrlKey)" title="Move up, hold shift or ctrl to move to top">&#9650;</button>
              <button class=flat disabled="{{@index === @last}}" on-click="moveDown(@context, @event.shiftKey || @event.ctrlKey)" title="Move down, hold shift or ctrl to move to bottom">&#9660;</button>
              <button on-click="@.scratch(.)" title="Open this scratch pad.">Open</button>
              <button on-click="@.splice('scratchPads', @index, 1)" title="Remove this scratch pad from browser storage.">Remove</button>
            </div>
          </div>
        {{else}}
          No scratch pads have been saved.
        {{/each}}
      </div>
    </tab>
    <tab title="Settings">
      <div style="display: flex; flex-direction: column;">
        <fieldset>
          <legend>Client Options</legend>
          <label as-field>Theme<select value="{{~/settings.theme}}">
            <option value="{{undefined}}">Auto</option>
            <option value="dark">Dark</option>
            <option value="light">Light</option>
          </select></label>
          <label as-field>Paste Timeout ms<input type=number placeholder=10000 step=1000 value="{{~/settings.pasteTimeout}}" /></label>
        </fieldset>
        <fieldset style="margin-top: 1em;">
          <legend>Diff Entries Options</legend>
          {{#if !@global.clientOnly}}
            <label as-field class=inline><input type=checkbox bind-checked="~/settings.allowUndoSegment" /> Enable undoing diff segments by default?</label>
            <label as-field class=inline><input type=checkbox bind-checked="~/settings.allowUndoSingle" /> Enable undoing individual diff entries by default?</label>
          {{/if}}
          <label as-field class=inline><input type=checkbox bind-checked="~/settings.hideBlankFields" /> Hide empty string fields in diff records by default?</label>
          <label as-field class=inline><input type=checkbox bind-checked="~/settings.hideDefaultFields" /> Hide defaulted fields in diff records by default?</label>
        </fieldset>
        <fieldset style="margin-top: 1em;">
          <legend>Query Options</legend>
          {{#if !@global.clientOnly}}
            <label as-field class=inline><input type=checkbox bind-checked="~/settings.queryOrderColumns" /> Order query result columns alphabetically?</label>
          {{/if}}
        </fieldset>
        <fieldset style="margin-top: 1em;">
          <legend>Editor Options</legend>
          <label as-field class=inline><input type=checkbox checked="{{~/settings.editor.highlightActive}}" /> Highlight active line?</label>
          <label as-field class=inline><input type=checkbox checked="{{~/settings.editor.wrap}}" /> Word wrap?</label>
          <label as-field class=inline><input type=checkbox checked="{{~/settings.editor.printMargin}}" /> Show print margin?</label>
          <div class=break />
          <label as-field>Input Mode<select value="{{~/settings.editor.keymode}}">
            <option value="{{undefined}}">default</option>
            <option>emacs</option>
            <option>sublime</option>
            <option>vim</option>
            <option>vscode</option>
          </select></label>
        </fieldset>
        <fieldset style="margin-top: 1em;">
          <legend>Delimited Text Options</legend>
          <label as-field title="The delimiter to use between fields when rendering a data set as delimited text e.g. , (comma), \t (tab), | (pipe). Defaults to ,">Field Delimiter<input value="{{~/settings.csv.field}}" placeholder="," /></label>
          <label as-field title="The delimiter to use between records when rendering a data set as delimited text e.g. \n (line feed), \r (carriage return), \r\n (carriage return, line feed). Defaults to \n">Record Delimiter<input value="{{~/settings.csv.record}}" placeholder="\n" /></label>
          <label as-field title="The quote to use around fields when rendering a data set as delimited text e.g. ' (single quote), &quot; (double quote), $$ (dollar, dollar). Defaults to none">Field Quote<input value="{{~/settings.csv.quote}}" /></label>
        </fieldset>
        <fieldset style="margin-top: 1em;">
          <legend>Local Diff Options</legend>
          <label as-field>Default Left Mode<select value="{{~/settings.diff.leftview}}"><option value="{{undefined}}">tree</option><option>text</option></select></label>
          <label as-field>Default Right Mode<select value="{{~/settings.diff.rightview}}"><option value="{{undefined}}">tree</option><option>text</option></select></label>
          <label as-field>Default Value Format<select value="{{~/settings.diff.format}}"><option value="{{undefined}}">raport</option><option>json</option></select></label>
        </fieldset>
        <div style="margin-top: 1em;">
          <button on-click="@.exportSettings()">Export Settings</button>
          <button on-click="@.importSettings()">Import Settings</button>
        </div>
      </div>
    </tab>
  </tabs>
  <buttons>
    {{#unless @global.clientOnly}}
      <button left title="Open a new Host Explorer window to browse databases on all connections, view schema, query across multiple databases, and run reports." on-click="@.exploreHosts()">Host Explorer</button>
      <button left title="Open a new two-way diff window for local data." on-click="@.localDiff()">Local Diff</button>
      <button class=reject on-click="@.halt()">Stop pg-difficult</button>
    {{/unless}}
  </buttons>
</script>

<script type=text/ractive id=query>
  <div style="border-bottom: 1px solid; display: flex; justify-content: space-between;">
    <button on-click="@.runQuery(~/query)" title="Execute this query and return the result. (ctrl+Enter){{'\n\n'}}Highlight text to execute only the highlighted portion as a query.">Run</button>
    <label as-field class=inline><input type=checkbox bind-checked="~/settings.queryOrderColumns" /> Order query result columns alphabetically?</label>
    {{#if ~/loadedQuery}}
      <button on-click="@.loadQuery()" title="Load the selected saved query in this window.">Load Query</button>
    {{elseif ~/query}}
      <div>
        <button on-click="@.saveQuery()" title="Save this query to the control panel Saved Queries.">Save</button>
        {{#if ~/name}}<button on-click="@.set('name', undefined)" title="This query is currently saved as {{~/name}}. Click here to disconnect this query from that named query. When the query is disconnected, it may be saved with a different name.">Unload</button>{{/if}}
      </div>
    {{/if}}
    {{#if ~/result.length}}
      <button title="Download this query result as delimited text (csv/tsv)." on-click="@.downloadQuery(~/result)">Download</button>
    {{/if}}
  </div>
  <div class="query" style="position: relative;">
    <split>
      <div size=20 class="query-text" as-tracked=`ace` as-ace="{ bind: '~/query', syntax: 'pgsql', theme: @style.theme == 'dark' ? 'tomorrow_night_eighties' : 'github', wrap: ~/editor.wrap, highlightActive: ~/editor.highlightActive, fontSize: '1em', font: 'monospace', printMargin: ~/editor.printMargin, keymode: ~/editor.keymode }" on-keydown="@event.ctrlKey && @event.key === 'Enter' ? @.runQuery(~/query) : true" />
      <div class="result">
        <data-table auto-titles no-wrap fixed-header allow-select=false on-init="@.set('@.table', $1)" items="{{~/result}}">
          <bottom>
            <div style="display:flex; justify-content: space-between;">
              <span>{{#if !~/result.length && ~/affected != null}}{{~/affected}} rows affected.{{/if}} {{#unless ~/error}}{{~/result.length || 'No'}} rows{{#if ~/result.length}}, {{@.table.data.columns.length}} cols{{/if}}{{/unless}}</span>
              <span>{{#if ~/runtime != null}}Completed in {{~/runtime}}ms{{/if}}</span>
            </div>
          </bottom>
        </data-table>
      </div>
    </split>
  </div>
</script>

<script type=text/ractive id=entries>
  <div class="content-wrapper">
    <div class="controls">
      {{#if @.source && !~/loaded}}
        <label as-field title="The segment name groups sets of changes together. The segment will automatically be updated when you stop typing, and any new changes will get the new segment name.">Segment<input value="{{~/newSegment}}" lazy=1500 /></label>
      {{/if}}
      <label class=filter class-error="~/exprError" as-field title="Raport expression used to filter out entries. Available fields are id, new, old, schema, segment, source, stamp, and table. new and old are objects containing the fields that changed in the record. table, schema, source, and segment are strings.{{#if ~/exprError}}{{'\n\nError: ' + ~/exprError.message + '\n' + ~/exprError.marked}}{{/if}}">Filter Expression<input value="{{expr}}" lazy=1000 /></label>
      <button as-pop=`~/showSettings`>&#9881;</button>
    </div>
    <virtual-list bind-items="~/entries" size=75>
      <header>
        {{#if .segment}}
          <div class=header><h2 title="Double click to rename segment" on-dblclick="@.renameSegment(.), false">{{.segment}}</h2> <div class=buttons style="padding-top: 0.9em;">{{#if ~/allowUndoSegment}}<button class=undo on-click="@.undoSegment(.), false" title="Undo all changes in this segment by replaying the changes in reverse. This will also create a new segment named 'Undo {{.segment}}', unless you hold the ctrl key when clicking this button.">Undo</button>{{/if}}</div></div>
        {{/if}}
      </header>
      {{#with . as record, @.details(.) as entry}}
        {{#if entry.status}}
          {{#if entry.changed}}
            <div class="wrapper striped-{{index % 2 == 0 ? 'even' : 'odd'}}" on-click="@event.shiftKey ? copyToClipboard(record.old || {}, 'Copied old record JSON to clipboard.') : copyToClipboard(Object.keys(record.new).length !== Object.keys(record.old).length ? Object.assign({}, record.old, record.new) : record.new || {}, 'Copied new record JSON to clipboard.'), false">
              <div class=name><span>{{record.table}} {{entry.id || ''}} {{entry.status}}</span><span class=src>({{record.source}})</span></div>
              {{#each entry.changed}}
                <div class="diff">
                  <div class="name">{{this.0}}</div>
                  <div class="left" on-click="copyToClipboard(this.1.0, 'Copied value to clipboard.'), false">{{typeof this.1.0 === 'object' ? JSON.stringify(this.1.0) : this.1.0}}</div>
                  <div class="right" on-click="copyToClipboard(this.1.1, 'Copied value to clipboard.'), false">{{typeof this.1.1 === 'object' ? JSON.stringify(this.1.1) : this.1.1}}</div>
                </div>
              {{/each}}

              <div class=buttons>
                {{#if ~/allowUndoSingle}}<button class=undo on-click="@.undoSingle(record), false" title="Undo this change by running the inverse of the statment that created the change.">Undo</button>{{/if}}
                <button class=split-up title="Split this entry and all entries above it up to the previous segment into a new segment" on-click="@.renameSegment(record, 'above'), false">&#9650;</button> <button class=split-down title="Split this entry and all entries below it down to the next segment into a new segment" on-click="@.renameSegment(record, 'below'), false">&#9660;</button>
              </div>
            </div>
          {{else}}
            <div class="diff whole striped-{{index % 2 == 0 ? 'even' : 'odd'}}" on-click="@event.shiftKey ? copyToClipboard(record.old || {}, 'Copied old record JSON to clipboard.') : copyToClipboard(record.new || {}, 'Copied new record JSON to clipboard.'), false">
              <div class=name><span>{{record.table}} {{entry.id || ''}} {{entry.status}}</span><span class=src>({{record.source}})</span></div>
              {{#each entry.record}}
                <div class="entry"><div class="key">{{this.0}}</div><div class="value" on-click="copyToClipboard(this.1, 'Copied value to clipboard.'), false">{{typeof this.1 === 'object' ? JSON.stringify(this.1) : this.1}}</div></div>
              {{/each}}

              <div class=buttons>
                {{#if ~/allowUndoSingle}}<button class=undo on-click="@.undoSingle(record), false" title="Undo this change by running the inverse of the statment that created the change.">Undo</button>{{/if}}
                <button class=split-up title="Split this entry and all entries above it up to the previous segment into a new segment" on-click="@.renameSegment(record, 'above'), false">&#9650;</button> <button class=split-down title="Split this entry and all entries below it down to the next segment into a new segment" on-click="@.renameSegment(record, 'below'), false">&#9660;</button>
              </div>
            </div>
          {{/if}}
        {{else}}
          <div class="wrapper striped-{{index % 2 == 0 ? 'even' : 'odd'}}" on-click="@event.shiftKey ? copyToClipboard(record.old || {}, 'Copied old record JSON to clipboard.') : copyToClipboard(record.new || {}, 'Copied new record JSON to clipboard.'), false">
            <div class=name><span>{{record.table}} {{entry.id || ''}} {{entry.status || '(empty changeset)'}}</span><span class=src>({{record.source}})</span></div>
            <div class=buttons>
              <button class=split-up title="Split this entry and all entries above it up to the previous segment into a new segment" on-click="@.renameSegment(record, 'above'), false">&#9650;</button> <button class=split-down title="Split this entry and all entries below it down to the next segment into a new segment" on-click="@.renameSegment(record, 'below'), false">&#9660;</button>
            </div>
          </div>
        {{/if}}
      {{/with}}
      {{#if ~/entries[index + 1] && ~/entries[index + 1].segment !== .segment}}{{#with ~/entries[index + 1]}}
        <div class=header><h2 title="Double click to rename segment" on-dblclick="@.renameSegment(.), false">{{.segment}}</h2> <div class=buttons style="padding-top: 0.9em;">{{#if ~/allowUndoSegment}}<button class=undo on-click="@.undoSegment(.), false" title="Undo all changes in this segment by replaying the changes in reverse. This will also create a new segment named 'Undo {{.segment}}', unless you hold the ctrl key when clicking this button.">Undo</button>{{/if}}</div></div>
      {{/with}}{{/if}}
      <else>
        {{#if ~/exprError}}<code class=expr>{{~/expr}}</code> is an invalid filter.<br /><br /><pre>Error: {{~/exprError.message + '\n\n'}}{{~/exprError.marked}}</pre>{{else}}No change entries have been recorded.{{/if}}
      </else>
    </virtual-list>
  </div>
  <pop bind-popped="~/showSettings" where="below" align="end" tail>
    <div style="width: 26em; display: flex; flex-direction: column;">
      {{#if @.source && !~/loaded}}
        <label class=inline as-field title="Check to enable undoing segments"><input type=checkbox bind-checked="~/allowUndoSegment" /> Undo segments?</label>
        <label class=inline as-field title="Check to enable undoing individual entries"><input type=checkbox bind-checked="~/allowUndoSingle" /> Undo single?</label>
      {{/if}}
      {{#if schemas}}
        <label class=inline as-field title="Check to hide empty string fields in entries"><input type=checkbox bind-checked="~/hideBlankFields" /> Hide blank?</label>
        <label class=inline as-field title="Check to hide fields with default values in entries"><input type=checkbox bind-checked="~/hideDefaultFields" /> Hide default?</label>
      {{/if}}
      {{#unless (@.source && !~/loaded) && schemas}}
        <div />
      {{/unless}}
    </div>
    <div style="display: flex; justify-content: space-between;">
      {{#if ~/entries.length}}
        <button class=reject on-click="@.clearEntries()" title="Remove recorded entries {{#if !~/loaded && !@.source}}for all diffs{{else}}for only this diff. Hold the ctrl key and click to clear all diff entries.{{/if}}.">Clear Entries</button>
      {{else}}
        <div />
      {{/if}}
      {{#if ~/entries.length}}
        <button class=download on-click="@.download()" title="Download a file containing these entries. Hold the ctrl key while clicking to open a popup window of the HTML. Hold the shift key while clicking to download the HTML directly.">Download</button>
      {{else}}
        <div />
      {{/if}}
    </div>
  </pop>
</script>

<script type=text/ractive id=entries-text>
  <div class=content-wrapper>
  {{#each ~/entries as record}}{{#with @.details(record) as entry}}
    {{#if @index === 0 || ~/entries[@index - 1].segment !== .segment}}<div class=header><h2>{{.segment}}</h2></div>{{/if}}
    {{#if entry.status}}
      {{#if entry.changed}}
        <div class="wrapper striped">
          <div class=name><span>{{record.table}} {{entry.id || ''}} {{entry.status}}</span><span class=src>({{record.source}})</span></div>
          {{#each entry.changed}}
            <div class="diff">
              <div class="name">{{this.0}}</div>
              <div class="left">{{typeof this.1.0 === 'object' ? JSON.stringify(this.1.0) : this.1.0}}</div>
              <div class="right">{{typeof this.1.1 === 'object' ? JSON.stringify(this.1.1) : this.1.1}}</div>
            </div>
          {{/each}}
        </div>
      {{else}}
        <div class="diff whole striped">
          <div class=name><span>{{record.table}} {{entry.id || ''}} {{entry.status}}</span><span class=src>{{record.source}}</span></div>
          {{#each entry.record}}
            <div class="entry"><div class="key">{{this.0}}</div><div class="value">{{typeof this.1 === 'object' ? JSON.stringify(this.1) : this.1}}</div></div>
          {{/each}}
        </div>
      {{/if}}
    {{/if}}
  {{/with}}{{else}}
    No change entries have been recorded.
  {{/each}}
  </div>
</script>

<script type=text/ractive id=leaks>
  {{#partial leak}}
    <div>Updated {{age(~/status.lastUpdate)}}</div>
    <div class="leak header">
      <div class=user>User</div>
      <div class=application>Application</div>
      <div class=client>Client</div>
      <div class=state>State</div>
      <div class=started>Started</div>
      <div class=constr>Connection</div>
      <div class=pid>Process ID</div>
    </div>
    {{#each leaks}}
      <div class="leak striped">
        <div class=user>{{.user}}</div>
        <div class=application>{{.application}}</div>
        <div class=client>{{.client}}</div>
        <div class=state>{{.state}}</div>
        <div class=started title="{{.started}}">{{age(.started)}}</div>
        <div class=constr>{{.source}}</div>
        <div class=pid>{{.pid}}</div>
      </div>
    {{else}}
      No connections.
    {{/each}}
  {{/partial}}
  <tabs style="overflow: hidden;" no-pad>
    <tab title="Added">
      <div class=content-wrapper>{{>leak leaks as leaks}}</div>
    </tab>
    <tab title="Current" defer>
      <div class=content-wrapper>{{>leak current as leaks}}</div>
    </tab>
    <tab title="Initial" defer>
      <div class=content-wrapper>{{>leak initial as leaks}}</div>
    </tab>
  </tabs>
</script>

<script type=text/ractive id=schema>
  <div class=content-wrapper>
    {{#with ~/entries as entries, ~/schema as _schema, @.config as _config}}
      {{>schema-inner}}
    {{/with}}
  </div>
</script>

<script type=text/ractive id=schema-inner>
  <tabs style="height: calc(100% - 2px); margin-top: 2px;">
    <tab title=Tables>
      <virtual-list bind-items="tables" size=34 style="flex-grow: 1;">
        <header>
          <div style="border-bottom: 1px solid;">
            <div class="stretch-fields">
              <label as-field>Search<input value="{{~/schemafilter}}" lazy=500 /></label>
              <label as-field title="Available fields are column.{name, default, enum, type, pgtype, nullable, length, precision, pkey, schema, table, description}">Expression<input value="{{~/schemaexpr}}" lazy=500 /></label>
              {{#if !~/compareSchema || ~/compareSchema.schema !== _schema}}
                <label as-field style="flex-grow: 0;"><button on-click="@.compareSchema(_schema, _config)" title="Compare this schema to another database's schema.">Compare</button></label>
              {{else}}
                <label as-field style="flex-grow: 0;"><button on-click="@.set('compareSchema', undefined)" title="Cancel waiting for another schema to be selected to compare to this schema.">Cancel</button></label>
              {{/if}}
              <label as-field style="flex-grow: 0;"><button on-click="@.downloadSchema(_schema)" title="Download a file containing this schema.">Download</button></label>
            </div>
            <div class="schema-row" style="font-weight: bold;">
              <div class="name" style="cursor: pointer;" title="Click to sort columns by {{~/schemasort === 'position' ? 'name' : 'position'}}" on-click="@.set('schemasort', ~/schemasort === 'position' ? 'name' : 'position')">Name ({{~/schemasort === 'position' ? '#' : 'A'}})</div>
              <div class="nullable">Null</div>
              <div class="default">Default</div>
              <div class="type">Type</div>
              <div class="size">Size</div>
            </div>
          </div>
          {{#if index}}
            <div class="schema-row table" style="padding: 0.5em;" on-click="@.toggle('schemaexpanded.table.' + escapeKey(.table || .name))">
              <div class="name">{{.table || .name}}</div>
              <div class="details">({{@.colsFor(.table || .name, 'tables')}} cols{{#if ~/schemafilter || ~/schemaexpr}}, {{~/schemaMatches.tables[.table || .name].length}} match{{/if}})</div>
            </div>
          {{/if}}
        </header>
        <item class="striped-{{index % 2 ? 'odd' : 'even'}}">
          {{#if !.table}}
            <div class="schema-row table" on-click="@.toggle('schemaexpanded.table.' + escapeKey(.name))">
              <div class="name" {{#if .description}}title="{{.description}}"{{/if}}>{{.name}}</div>
              <div class="details">({{.columns.length}} cols{{#if ~/schemafilter || ~/schemaexpr}}, {{~/schemaMatches.tables[.name].length}} match{{/if}})</div>
            </div>
          {{else}}
            <div class="schema-row column">
              <div class="name {{#if .pkey}}pkey{{/if}}" {{#if .description}}title="{{.description}}"{{/if}}>
                <div class=expand-indicator class-expanded class-matched />
                {{.name}}
              </div>
              <div class="nullable">{{.nullable ? 'Y' : 'N'}}</div>
              <div class="default" {{#if .default}}title="{{.default}}"{{/if}}>{{.default ? 'Y' : 'N'}}</div>
              <div class="type" {{#if .enum}}title="Values: {{.enum.join(', ')}}"{{/if}}>{{.pgtype}}</div>
              <div class="size">{{#if .length != null}}{{.length}}{{elseif .precision != null}}{{.precision}}{{/if}}</div>
            </div>
          {{/if}}
        </item>
        <else>
          <div class="schema-row">
            No {{#if ~/schemafilter || ~/schemaexpr}}matching{{/if}} tables or columns.
          </div>
        </else>
      </virtual-list>
      <div style="padding: 0.5em; border-top: 1px solid;">
        {{_schema.tables.length}} tables, {{@.colCount(_schema, 'tables')}} columns{{#if ~/schemafilter || ~/schemaexpr}}, {{@.schemaMatchCount(~/schemaMatches.tables)}} match{{/if}}
      </div>
    </tab>
    <tab title=Views>
      <virtual-list bind-items="views" size=34 style="flex-grow: 1;">
        <header>
          <div style="border-bottom: 1px solid;">
            <div class="stretch-fields">
              <label as-field>Search<input value="{{~/schemafilter}}" lazy=500 /></label>
              <label as-field title="Available fields are column.{name, default, enum, type, pgtype, nullable, length, precision, pkey, schema, table}">Expression<input value="{{~/schemaexpr}}" lazy=500 /></label>
              {{#if !~/compareSchema || ~/compareSchema.schema !== _schema}}
                <label as-field style="flex-grow: 0;"><button on-click="@.compareSchema(_schema, _config)" title="Compare this schema to another database's schema.">Compare</button></label>
              {{else}}
                <label as-field style="flex-grow: 0;"><button on-click="@.set('compareSchema', undefined)" title="Cancel waiting for another schema to be selected to compare to this schema.">Cancel</button></label>
              {{/if}}
              <label as-field style="flex-grow: 0;"><button on-click="@.downloadSchema(_schema)" title="Download a file containing this schema.">Download</button></label>
            </div>
            <div class="schema-row" style="font-weight: bold;">
              <div class="name" style="cursor: pointer;" title="Click to sort columns by {{~/schemasort === 'position' ? 'name' : 'position'}}" on-click="@.set('schemasort', ~/schemasort === 'position' ? 'name' : 'position')">Name ({{~/schemasort === 'position' ? '#' : 'A'}})</div>
              <div class="nullable">Null</div>
              <div class="default">Default</div>
              <div class="type">Type</div>
              <div class="size">Size</div>
            </div>
          </div>
          {{#if index}}
            <div class="schema-row table" style="padding: 0.5em;" on-click="@.toggle('schemaexpanded.view.' + escapeKey(.table || .name))">
              <div class="name">{{.table || .name}}</div>
              <div class="details">({{@.colsFor(.table || .name, 'views')}} cols{{#if ~/schemafilter || ~/schemaexpr}}, {{~/schemaMatches.tables[.table || .name].length}} match{{/if}})</div>
            </div>
          {{/if}}
        </header>
        <item class="striped-{{index % 2 ? 'odd' : 'even'}}">
          {{#if !.table}}
            <div class="schema-row table" on-click="@.toggle('schemaexpanded.view.' + escapeKey(.name))">
              <div class="name" {{#if .description}}title="{{.description}}"{{/if}}>{{.name}}</div>
              <div class="details">({{.columns.length}} cols{{#if ~/schemafilter || ~/schemaexpr}}, {{~/schemaMatches.views[.name].length}} match{{/if}})</div>
            </div>
          {{else}}
            <div class="schema-row column">
              <div class="name {{#if .pkey}}pkey{{/if}}" {{#if .description}}title="{{.description}}"{{/if}}>
                <div class=expand-indicator class-expanded class-matched />
                {{.name}}
              </div>
              <div class="nullable">{{.nullable ? 'Y' : 'N'}}</div>
              <div class="default" {{#if .default}}title="{{.default}}"{{/if}}>{{.default ? 'Y' : 'N'}}</div>
              <div class="type" {{#if .enum}}title="Values: {{.enum.join(', ')}}"{{/if}}>{{.pgtype}}</div>
              <div class="size">{{#if .length != null}}{{.length}}{{elseif .precision != null}}{{.precision}}{{/if}}</div>
            </div>
          {{/if}}
        </item>
        <else>
          <div class="schema-row">
            No {{#if ~/schemafilter || ~/schemaexpr}}matching{{/if}} views or columns.
          </div>
        </else>
      </virtual-list>
      <div style="padding: 0.5em; border-top: 1px solid;">
        {{_schema.views.length}} views, {{@.colCount(_schema, 'views')}} columns{{#if ~/schemafilter || ~/schemaexpr}}, {{@.schemaMatchCount(~/schemaMatches.views)}} match{{/if}}
      </div>
    </tab>
    <tab title=Functions>
      <virtual-list bind-items="functions" size=34 style="flex-grow: 1;">
        <header>
          <div style="border-bottom: 1px solid; margin-top: 0.25em;">
            <div class="schema-row fn" style="font-weight: bold;">
              <div class="name">Name</div>
              <div class="lang">Language</div>
              <div class="args">Arguments</div>
              <div class="result">Result</div>
            </div>
          </div>
        </header>
        <item class="striped-{{index % 2 ? 'odd' : 'even'}}">
          <div class="schema-row fn">
            <div class="name" title="{{.type}} {{.name}}({{.arguments}}): {{.result}}{{'\n--------\n'}}{{.source}}" on-click="copyToClipboard(@event.shiftKey ? `${.type} ${.name}(${.arguments}): ${.result}\n--------\n${.source}` : .source, `Copied ${.name} source to clipboard.`)">{{.name}}</div>
            <div class="lang" title="{{.language}}">{{.language}}</div>
            <div class="args" title="{{.arguments}}">{{.arguments}}</div>
            <div class="result" title="{{.result}}">{{.result}}</div>
          </div>
        </item>
        <else>
          <div class="schema-row">
            No funtions
          </div>
        </else>
      </virtual-list>
      <div style="padding: 0.5em; border-top: 1px solid;">
        {{_schema.functions.length}} functions
      </div>
    </tab>
  </tabs>
</script>

<script type=text/ractive id=schema-compare>
  <div class=content-wrapper>
    {{#each diff as pair}}
      {{#if pair[0] != null && pair[1] != null}}
        <div class="schema-diff striped">
          <div class="name" title="{{@key}}">{{@key}}</div>
          <div class="left" title="{{pair[0]}}">{{pair[0]}}</div>
          <div class="right" title="{{pair[1]}}">{{pair[1]}}</div>
        </div>
      {{else}}
        <div class="schema-diff whole striped">
          <div class="name">{{#if pair[0] == null}}Added{{else}}Removed{{/if}} {{@key}}</div>
          {{#each pair[0] || pair[1]}}
            <div class="entry"><div class="key">{{@key}}</div><div class="value">{{.}}</div></div>
          {{/each}}
        </div>
      {{/if}}
    {{else}}
      No differences.
    {{/each}}
  </div>
</script>

<script type=text/ractive id=scratch-pad>
  <div style="display: flex; justify-content: space-between; flex-shrink: 0;">
    <label as-field class=inline><input value="{{pad.name}}" placeholder="Name..." lazy=1000 /></label>
    <label as-field class=inline><select value="{{pad.syntax}}" lazy=1000>
      <option value="{{undefined}}">plain text</option>
      <option>markdown</option>
      <option>json</option>
      <option>pgsql</option>
      <option>javascript</option>
      <option>typescript</option>
      <option>ejs</option>
      <option>handlebars</option>
      <option>csharp</option>
    </select></label>
  </div>
  <div style="flex-grow: 1;" as-ace="{ bind: 'pad.text', syntax: pad.syntax || 'plain_text', theme: @style.theme == 'dark' ? 'tomorrow_night_eighties' : 'github', wrap: ~/editor.wrap, highlightActive: ~/editor.highlightActive, fontSize: '1em', font: 'monospace', printMargin: ~/editor.printMargin, keymode: ~/editor.keymode }" />
</script>

<script type=text/ractive id=host-explore>
  <div style="display: flex; height: 100%;">
    <div style="width: 22em; flex-shrink: 0; flex-grow: 0; border-right: 1px solid; padding: 0.5em; overflow: auto;">
      <div class=filter-pane style="position: sticky; top: -0.5em; border-bottom: 1px solid; padding: 0.5em; margin: -0.5em -0.5em 0.5em -0.5em; display: flex;" title="Filter visible databases using a raport expression. Visible databases will be condidates to query all, so collapsing a host node will prevent any databases on that node from being queried.{{'\n\n'}}Available fields are connection: { host, port, username, password, database, ssl, label }, entry: { access, collate, ctype, data, encoding, owner }, constr, db, index, query, last-query{{'\n\n'}}Any applied query results are also available here by their applied name as a property of query. If a query is run and not applied or saved as a result, it will be available as last-query.">
        <label as-field class=inline style="width: 100%;">
          <input value="{{~/filter}}" style="flex-grow: 1; padding: 0.25em;" lazy=1000 placeholder="Filter Expression" />
        </label>
      </div>
      {{#each ~/connections as con}}
        <div class="host" style="display: flex; position: sticky; top: 4.1em; word-break: break-all; align-items: center; justify-content: space-between;" on-click="@.toggle('expanded.' + escapeKey(.constr))">
          <div style="width: 1em; height: 1em; display: flex; border: 1px solid; align-items: center; justify-content: center; margin-right: 0.5em; flex-shrink: 0;">
            {{#if ~/expanded[.constr]}}-{{else}}+{{/if}}
          </div>
          <div style="padding: 0.2em;">{{#if .label}}<strong>{{.label}}</strong> <em>({{.constr}})</em>{{else}}<em>{{.constr}}</em>{{/if}}{{#if ~/hosts && ~/expanded[.constr] && Array.isArray(~/hosts[.constr])}} ({{~/_entries[.constr].length}} / {{~/hosts[.constr].length}}){{/if}}</div>
          <div class="round fade" on-click="@.refreshHost(con), false" title="Refresh host database list">&#10227;</div>
        </div>
        <div style="padding-left: 1.5em;">
          {{#if ~/expanded[.constr]}}
            {{#if ~/hosts[.constr].error}}
              <div style="display: flex; padding: 0.2em; justify-content: space-between; color: darkred;"><span>{{~/hosts[.constr].error}}</span></div>
            {{elseif ~/hosts && Array.isArray(~/hosts[.constr])}}
              {{#each ~/_entries[.constr] as entry}}
                <div style="display: flex; padding: 0.2em; justify-content: space-between;" on-click="@.set('selectedDB', { connection: con, entry: entry })" class-selected="~/selectedDB.connection.constr === con.constr && ~/selectedDB.entry.database === .database"><span>{{.database}}</span></div>
              {{/each}}
            {{else}}
              <div style="padding: 0.5em;">[[@.refreshHost(.) && 'Loading...']]</div>
            {{/if}}
          {{/if}}
        </div>
      {{/each}}
    </div>
    <tabs pad style="overflow: hidden;" flex>
      <tab no-pad title="Database">
        {{#if ~/selectedDB}}
          {{#with ~/selectedDB}}
            <tabs defer style="overflow: hidden; margin-top: 2px; flex-grow: 1;" pad flex>
              <tab title="Info">
                <div style="padding: 0.5em;">
                  {{.entry.database}} on {{.connection.config.host}}:{{.connection.config.port}}
                  <table>
                    {{#each .entry}}
                      <tr><th>{{@key}}</th><td>{{.}}</td></tr>
                    {{/each}}
                  </table>
                </div>
              </tab>
              <tab title="Schema" on-enter="@.set('showSchema', true)" on-leave="@.set('showSchema', false)" no-pad>
                {{#if ~/showSchema}}
                  {{#if ~/schemas[.connection.constr + '@' + .entry.database]}}
                    {{#with Object.assign({}, .connection.config, { database: .entry.database }) as _config}}
                      {{#with ~/schemas[.connection.constr + '@' + .entry.database]}}
                        {{#if .error}}
                          <div style="padding: 0.5em;">Error loading schema...</div>
                        {{else}}
                          {{#with @.schemaEntries(.schema, 'tables') as tables, @.schemaEntries(.schema, 'views') as views, .schema.functions as functions, .schema as _schema}}
                            {{>schema-inner}}
                          {{/with}}
                        {{/if}}
                      {{/with}}
                    {{/with}}
                  {{else}}
                    <div style="padding: 0.5em;">[[@.refreshSchema(.) && 'Loading...']]</div>
                  {{/if}}
                {{/if}}
              </tab>
              <tab title="Query" no-pad>
                <div style="position: relative; height: 100%; flex-grow: 1; display: flex; flex-direction: column;">
                  {{>query}}
                </div>
              </tab>
              <tab title="Reports" no-pad>
                <div style="display: flex; height: 100%; margin-top: 2px;">
                  <div style="flex-grow: 1;">
                    {{#if ~/queryreport}}
                      <tabs style="overflow: hidden;" flex pad>
                        <tab title="Details">
                          <div style="display: flex; justify-content: space-between; align-items: center;"><span>{{~/queryreport.definition.name}}</span><button on-click="@.reportDesigner(~/queryreport)">Report Designer</button></div>
                          <h3>Queries</h3>
                          <dl>
                            {{#each ~/queryreport.sources}}
                              {{#if .type === 'query'}}
                                <dt>{{.name}}</dt><dd>{{.query}}</dd>
                              {{/if}}
                            {{/each}}
                          </dl>
                        </tab>
                        <tab title="Run">
                          <div>
                            {{#each ~/queryreport.definition.parameters}}
                              <label as-field>{{.label || .name}}<input value="{{~/params[.name]}}" /></label>
                            {{/each}}
                          </div>
                          <div>
                            <button on-click="@.runSingleReport(queryreport, false, ~/params)">Run Report</button>
                          </div>
                        </tab>
                      </tabs>
                    {{else}}
                      <div style="padding: 0.5em; opacity: 0.5;">
                        Select a report...
                      </div>
                    {{/if}}
                  </div>
                  <div style="width: 15em; flex-shrink: 0; background-color: rgba(128, 128, 128, 0.05); border-left: 1px solid #222;">
                    {{#each ~/reports}}
                      {{#if @.isJustQueryReport(.)}}
                        <div style="padding: 0.5em;" on-click="@.link(@keypath, 'queryreport')" class-selected="~/queryreport === .">{{.definition.name}}</div>
                      {{/if}}
                    {{/each}}
                  </div>
                </div>
              </tab>
            </tabs>
          {{/with}}
        {{else}}
          <div style="padding: 0.5em;">Select a database</div>
        {{/if}}
      </tab>
      <tab title="Query All" no-pad>
        <tabs style="margin-top: 2px; overflow: hidden; height: 100%;" pad flex>
          <tab title="Reports" no-pad>
            <div style="display: flex; height: 100%; margin-top: 2px;">
              <div style="flex-grow: 1;">
                {{#if ~/allreport}}
                  <tabs style="overflow: hidden;" flex pad>
                    <tab title="Details">
                      <div style="display: flex; justify-content: space-between; align-items: center;"><span>{{~/allreport.definition.name}}</span><button on-click="@.reportDesigner(~/allreport)">Report Designer</button></div>
                      <h3>Queries</h3>
                      <dl>
                        {{#each ~/allreport.sources}}
                          {{#if .type === 'query-all-sql'}}
                            <dt>{{.name}}</dt><dd>{{.query}}</dd>
                          {{/if}}
                        {{/each}}
                      </dl>
                    </tab>
                    <tab title="Run">
                      <div style="padding: 0.3em;">Reports will run against all visible databases in the Host Explorer tree.</div>
                      <div>
                        {{#each ~/allreport.definition.parameters}}
                          <label as-field>{{.label || .name}}<input value="{{~/params[.name]}}" /></label>
                        {{/each}}
                      </div>
                      <div>
                        <button on-click="@.runReport(allreport)">Run Report</button>
                      </div>
                    </tab>
                  </tabs>
                {{else}}
                  <div style="padding: 0.5em; opacity: 0.5;">
                    Select a report...
                  </div>
                {{/if}}
              </div>
              <div style="width: 15em; flex-shrink: 0; background-color: rgba(128, 128, 128, 0.05); border-left: 1px solid #222;">
                {{#each ~/reports}}
                  {{#if @.isQueryAllReport(.)}}
                    <div style="padding: 0.5em;" on-click="@.link(@keypath, 'allreport')" class-selected="~/allreport === .">{{.definition.name}}</div>
                  {{/if}}
                {{/each}}
              </div>
            </div>
          </tab>
          <tab title="Query">
            <div style="padding: 0.3em;">Queries will run against all visible databases in the Host Explorer tree. Queries run here are useful to extend data available for filtering. Results may be provided for reports, but having a report with a query all source is preferable.</div>
            <label as-field>SQL<textarea>{{~/queryall}}</textarea></label>
            <div>
              <label as-field title="Give a name to the result set to be available in the expression filter of this host explorer. Applied results are added to any existing results, so collapsing a host that already has results and rerunning a query will not remove the previous result.">Apply As<input value="{{~/queryapply}}" /></label>
              <label as-field><button on-click="@.queryAll(~/queryall, ~/queryapply), @.set('queryapply', '')">Run</button></label>
              <label as-field style="margin-left: 2em;"><button class-reject title="Clear cached results. To clear all, leave Apply As blank. To clear a specific set, fill the desired name in Apply As." on-click="@.set(~/queryapply ? 'results.' + escapeKey(~/queryapply) : 'results', {}), @.set('queryapply', '')">Clear Results</button></label>
              <hr />
              <label as-field title="Provide a result set with the given name, which will be available to any reports that have a provided query all source of the same name.">Provide Result<input value="{{~/queryname}}" /></label>
              <label as-field><button on-click="@.queryAll(~/queryall, undefined, ~/queryname), @.set('queryname', '')">Run</button></label>
              <label as-field style="margin-left: 2em;"><button class-reject title="Clear cached provided results. To clear all, leave Provided Result blank. To clear a specific set, fill the desired name in Provided Result." on-click="app.set(~/queryname ? 'results.' + escapeKey(~/queryname) : 'results', {}), @.set('queryname', '')">Clear Results</button></label>
            </div>
          </tab>
        </tabs>
      </tab>
    </tabs>
  </div>
</script>

<script type=text/ractive id=report>
  <iframe src="./report.html"></iframe>
  {{#unless ~/control.topmost}}<div style="position: absolute; top: 0; left: 0; right: 0; bottom: 0;" />{{/unless}}
  <buttons>
    <button left on-click="@.close()">Cancel</button>
    <button on-click="@.save()">Save</button>
  </buttons>
</script>

<script type=text/ractive id=view-report>
  <iframe srcdoc="{{html}}" />
</script>

<script type=text/ractive id=source-edit>
  <div class=content-wrapper>
    <div>
      <label as-field as-autofocus>Name<input value="{{source.name}}" /></label>
      <label as-field>Type<select value="{{source.type}}" on-change="@node.value === 'diff' ? @.set('source', { type: 'diff'}) : true">
        <option value="diff">Diff Entries</option>
        <option value="diff-schema">Diff Schema</option>
        {{#if !@global.clientOnly}}
          <option value="query">Query</option>
          <option value="query-all">Query All Provided Result</option>
          <option value="query-all-sql">Query All</option>
        {{/if}}
        <option value="json">JSON</option>
      </select></label>
      {{#if source.type === 'query'}}<label as-field><input type=checkbox checked="{{source.config !== undefined}}" twoway=false on-change="@.set('source.config', @node.checked ? {} : undefined)" /> Custom connection?</label>{{/if}}
    </div>
    {{#if source.type === 'query'}}
      {{#if !!source.config}}
        <div>
          <label as-field>Host<input value="{{source.config.host}}" /></label>
          <label as-field>Port<input type=number value="{{source.config.port}}" /></label>
          <label as-field>SSL<select value="{{source.config.ssl}}">
            <option value="{{undefined}}">Default</option>
            <option value="prefer">Prefer</option>
            <option value="require">Require</option>
            <option value="{{false}}">None</option>
          </select></label>
          <label as-field>User<input value="{{source.config.username}}" /></label>
          <label as-field>Password<input type=password value="{{source.config.password}}" /></label>
          <label as-field>Database<input value="{{source.config.database}}" /></label>
        </div>
      {{/if}}
      <div><label as-field>Query<textarea>{{source.query}}</textarea></label></div>
      {{#if ~/error}}<div style="color: red;">{{~/error}}</div>{{/if}}
      <div>
        {{#each ~/paramArray}}
          <label as-field>Parameter ${{@index + 1}}<input value="{{source.parameters[@index]}}" /></label>
        {{/each}}
      </div>
    {{elseif source.type === 'json'}}
      <label as-field>JSON<textarea>{{source.json}}</textarea></label>
    {{elseif source.type === 'query-all'}}
      <label as-field>Result Name<input value="{{source.result}}" /></label>
    {{elseif source.type === 'query-all-sql'}}
      <div><label as-field>Query<textarea>{{source.query}}</textarea></label></div>
      {{#if ~/error}}<div style="color: red;">{{~/error}}</div>{{/if}}
      <div>
        {{#each ~/paramArray}}
          <label as-field>Parameter ${{@index + 1}}<input value="{{source.parameters[@index]}}" /></label>
        {{/each}}
      </div>
    {{/if}}
  </div>
  <buttons>
    <button left on-click="@.close()">Cancel</button>
    <button on-click="@.save()" disabled="{{!!error}}">Done</button>
  </buttons>
</script>

<script type=text/ractive id=connect>
  <div class="connect">
    <label as-field as-autofocus>Host<input value="{{~/config.host}}" /></label>
    <label as-field>Port<input type=number value="{{~/config.port}}" /></label>
    <label as-field>User<input value="{{~/config.username}}" /></label>
    <label as-field>Password<input type=password value="{{~/config.password}}" /></label>
    <label as-field>Database<input value="{{~/config.database}}" /></label>
    <label as-field>SSL<select value="{{~/config.ssl}}">
      <option value="{{undefined}}">Default</option>
      <option value="prefer">Prefer</option>
      <option value="require">Require</option>
      <option value="{{false}}">None</option>
    </select></label>
    <label as-field>Label<input value="{{~/config.label}}" /></label>
    <fieldset style="margin: 1em 0.5em;">
      <legend>Diff Options</legend>
      <label as-field>Max Length <tip>The maximum allowable length of any value of any column to be recorded directly in a diff. Any values with lengths that exceed this number will instead be checksummed. This will affect your ability to undo diffs, as the checksummed value may not be valid in the source column. This defaults to 0, which disables the feature.</tip><input type=number value="{{~/config.diffopts.maxlen}}" placeholder="0" /></label>
      <label as-field>Change Records<select value="{{~/config.diffopts.changes}}">
        <option value="{{undefined}}">Record only changed fields and keys if possible.</option>
        <option value="whole">Always record the full old and new records.</option>
        <option value="whole-old">Always record the full old record and only changed fields and keys in the new record if possible.</option>
      </select></label>
      <field tip="This can be a table name, a schema.table name, or an ilike pattern that matches either table or schema.table. '__pgdifficult_%' and 'pgdifficult.%' are automatically ignored." label="Ignore Patterns" value="{{~/ignore}}"><button on-click="@.push('config.diffopts.ignore', ~/ignore), @.set('ignore', '')">Add</button></field>
      <h3 style="border-bottom: 1px solid; margin: 1em 0 0.5em 0;">Ignored Pattern List</h3>
      {{#each ~/config.diffopts.ignore}}
        <div class="wrapper striped-{{@index % 2 == 0 ? 'even' : 'odd'}}" style="display: flex;">
          <label as-field class=inline style="flex-grow: 1;"><input value="{{.}}" /></label>
          <label as-field class=inline style="flex-shrink: 0;"><button on-click="@.splice('~/config.diffopts.ignore', @index, 1)">Remove</button></label>
        </div>
      {{else}}
        <em>No ignored patterns</em>
      {{/each}}
    </fieldset>
  </div>
  <buttons>
    <button left class=flat on-click="@.cancel()">Cancel</button>
    <button on-click="@.accept()">Done</button>
  </buttons>
</script>

<script type=text/ractive id=diff>
  <div class=differ style="display: flex; width: 100%; height: 100%;">
    <split vertical>
      <div size=33 style="display: flex; flex-direction: column; position: relative; height: 100%;">
        <div style="display: flex; justify-content: space-evenly; align-items: center;">
          <h3>Left</h3>
          <select value="{{leftView}}"><option value="{{undefined}}">text</option><option>tree</option></select>
        </div>
        {{#if ~/copied.recent}}
          <div class=paster on-click="@.paste('left', @event.shiftKey)"><span>click to paste<br/>shift+click to apply patch</span></div>
        {{elseif leftView === 'tree'}}
          {{>root @.parse(.left)}}
        {{else}}
          <textarea style="flex-grow: 1; resize: none;" placeholder="Left value here..." lazy=1000>{{.left}}</textarea>
        {{/if}}
      </div>
      <div size=34 style="position: relative; padding: 0.2rem; display: flex; flex-direction: column; height: 100%; box-sizing: border-box;">
        <div style="display: flex; justify-content: space-evenly; align-items: center;">
          {{#if ~/leftView === 'tree' || ~/rightView === 'tree'}}<label style="font-size: 0.7em;"><input type=checkbox checked="{{~/expandAll}}"> Expand all tree nodes?</label>{{/if}}
          <h3>Diff</h3>
          <select value="{{format}}"><option value="{{undefined}}">raport</option><option>json</option></select>
        </div>
        <pre style="overflow: auto;"><code>
        {{#each @.diff(.left, .right)}}
          <div style="display: flex; flex-wrap: wrap;">
            <div style="width: 100%; margin-top: 0.5rem; border-bottom: 1px solid #999; padding: 0.2rem; font-weight: 600;">{{@key}}</div>
            <div style="width: 50%; padding: 0.5rem; box-sizing: border-box;">{{@.string(this.0)}}</div>
            <div style="width: 50%; padding: 0.5rem; box-sizing: border-box; border-left: 1px dotted #aaa;">{{{@.string(this.1, this.0)}}}</div>
          </div>
        {{/each}}
        </code></pre>
      </div>
      <div size=33 style="display: flex; flex-direction: column; position: relative; height: 100%;">
        <div style="display: flex; justify-content: space-evenly; align-items: center;">
          {{#if ~/hasCSV}}<label style="font-size: 0.7em;"><input type=checkbox checked="{{~/csvHeader}}"> CSV Header?</label>{{/if}}
          <h3>Right</h3>
          <select value="{{rightView}}"><option value="{{undefined}}">text</option><option>tree</option></select>
        </div>
        {{#if ~/copied.recent}}
          <div class=paster on-click="@.paste('right', @event.shiftKey)"><span>click to paste<br/>shift+click to apply patch</span></div>
        {{elseif rightView === 'tree'}}
          {{>root @.parse(.right)}}
        {{else}}
          <textarea style="flex-grow: 1; resize: none;" placeholder="Right value here..." lazy=1000>{{.right}}</textarea>
        {{/if}}
      </div>
    </split>
  </div>

  {{#partial root}}
    <div class=tree-view>
      {{#if typeof . === 'object' && .}}<span style="color: #aaa; margin-left: 0.5em;">{{Array.isArray(.) ? '[' : '{'}}</span>{{/if}}
      <div class=root>
        {{>tree .}}
      </div>
      {{#if typeof . === 'object' && .}}<span style="color: #aaa; margin-left: 0.5em;">{{Array.isArray(.) ? ']' : '}'}}</span>{{/if}}
    </div>
  {{/partial}}

  {{#partial tree}}
    <div class=tree>
      {{#each .}}
        <div class=node>
          <div class=key title="{{(@keypath + '').replace(/.*\)\./, '')}}">{{@key}}<span style="color: #aaa;">:</span>{{#if typeof . === 'object' && .}}<span style="color: #aaa; margin-left: 0.5em;">{{Array.isArray(.) ? '[' : '{'}}</span>{{/if}}</div>
          {{#unless ~/expandAll}}<div class=expand {{#if typeof . === 'object' && .}}class-show on-click="@.toggle('expand.' + escapeKey(@keypath))"{{/if}}>{{#if ~/expand[@keypath]}}-{{else}}+{{/if}}</div>{{/unless}}
          <div class=value class-children="typeof . === 'object' && . && (~/expandAll || ~/expand[@keypath])">
            {{#if typeof . === 'object' && .}}
              {{#if ~/expandAll || ~/expand[@keypath]}}
                {{>tree .}}
                <span style="color: #aaa; margin-left: 0.25em;">{{Array.isArray(.) ? ']' : '}'}}</span>
              {{else}}
                <div class=type>{{#if Array.isArray(.)}} ]{{else}} }{{/if}}</div>
              {{/if}}
            {{else}}{{@.string(.)}}{{/if}}
          </div>
        </div>
      {{/each}}
    </div>
  {{/partial}}
</script>

<script type=text/ractive id=confirm>
  <div class=content-wrapper>
    <div class="message" style="max-width: 36em;"><pre style="font-family: sans-serif;">{{{.message}}}</pre></div>
  </div>
  <buttons>
    <button center on-click="@.close(false, true)">Yes</button>
    <button center class=reject on-click="@.close(false, false)">No</button>
  </buttons>
</script>

<script type=text/ractive id=ask>
  <div class=content-wrapper>
    <div class="message" style="max-width: 36em;">{{.message}}</div>
    <label as-field class=inline><input as-autofocus value="{{.value}}" on-keydown="@event.key === 'Escape' ? @.close() : @event.key === 'Enter' ? @.close(true, ~/value) : true" /></label>
  </div>
  <buttons>
    <button left class=flat on-click="@.close()">Cancel</button>
    <button on-click="@.close(true, ~/value)">Done</button>
  </buttons>
</script>

<script type=text/ractive id=choose>
  <div class=content-wrapper>
    <div class="message" style="max-width: 36em;">{{.message}}</div>
  </div>
</script>

  </head>
  <body>
<div id=target />

<script src="./index.js"></script>
<script src="./ace@1.35.4/ace.js"></script>
<script>
  Ractive.use(RauiAceEditor.default({ name: 'ace' }));
</script>
  </body>
</html>
